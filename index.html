<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åå›åˆè³½é“æˆ°æ³å‹•ç•«ï¼ˆè³½é“ç‰ˆï¼‰</title>

  <style>
    :root{
      --bg:#f7fbff;
      --panel:#ffffff;
      --line:#d9e6ff;
      --text:#1b2a4a;
      --muted:#5b6b8f;
      --accent:#4ea1ff;
      --accent-2:#ffd166;
      --finish:#ffb703;
      --shadow: 0 12px 28px rgba(30,60,120,.12);
      --card-shadow: 0 10px 20px rgba(78,161,255,.12);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(900px 500px at 10% 10%, #ffffff 0%, #f2f7ff 60%);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      /* âœ… åªé—œæ‰å·¦å³æ²è»¸ï¼›ä¿ç•™ä¸Šä¸‹æ²å‹•ï¼ˆæ‰‹æ©Ÿæ‰çœ‹å¾—åˆ°å¾Œé¢çš„è³½é“ï¼‰ */
  min-height: 100vh;
  overflow-x: hidden;
  overflow-y: auto;
    }


    .app{
  max-width: none;
  width: 100%;
  margin: 18px auto;
  padding: 14px 24px;  /* ä¿ç•™ä¸€é»é‚Šè·å°±å¥½ï¼Œå¯è‡ªè¡Œèª¿æ•´ */
}
.viewport{
  width: 100%;
  min-height: 100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  overflow-x:hidden;
  overflow-y:auto;
}


#stage{
  width: 100%;
  max-width: 1400px;   /* æ¡Œæ©Ÿç½®ä¸­ */
  margin: 0 auto;
}


/* âœ… é›»è…¦ç‰ˆï¼šè®“èˆå°æ°¸é æ°´å¹³ç½®ä¸­ï¼Œä¸¦ä¸”ä¸è¦è¶…å‡ºè¦–çª— */
@media (min-width: 1101px){
  #stage{
    margin: 0 auto;
    max-width: calc(100vw - 48px); /* 48 = 24px*2ï¼Œå°æ‡‰ä½  .app çš„å·¦å³ padding */
  }
}

/* âœ… å°è¢å¹•ï¼šç¶­æŒä½ åŸæœ¬æ‰‹æ©Ÿçš„é¡¯ç¤ºï¼Œä¸å‹•å®ƒ */
@media (max-width: 1100px){
  #stage{
    width: 100%;
    max-width: 100%;
  }
}

    /* top bar */
    .topbar{
      display:flex; flex-direction:row; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    button{
      background: linear-gradient(180deg, rgba(78,161,255,.12), rgba(78,161,255,.06));
      color: var(--text);
      border: 1px solid rgba(78,161,255,.22);
      padding: 8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      box-shadow: var(--card-shadow);
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .speed{ display:flex; align-items:center; gap:8px; color: var(--muted); }
    #speed{ width:140px; }

       /* layout */
    .layout{
      display:grid;
      /* å·¦ï¼šå›åˆè·³è½‰ï¼‹é€šé—œ ï¼ ä¸­ï¼šå­—å¹•å¡ï¼‹è³½é“ ï¼ å³ï¼šå³æ™‚æ’å */
      grid-template-columns: 260px minmax(0,1fr) 300px;
      gap: 12px;
      align-items:flex-start;
    }
    @media (max-width:1100px){
      .layout{
        grid-template-columns: 1fr;
      }
    }

    /* å·¦å´ï¼šå›åˆå¿«é€Ÿè·³è½‰ + é€šé—œæ’å */
    .side-left{
      background: linear-gradient(180deg,#ffffff,#fbfdff);
      border: 2px solid rgba(78,161,255,.06);
      border-radius: 14px;
      padding:12px;
      box-shadow: var(--card-shadow);
      height: fit-content;
    }


    /* stageï¼šå·¦å´ä¸»ç•«é¢ */
    .stage{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(245,250,255,1));
      border: 1px solid rgba(78,161,255,.08);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 640px;
      overflow:visible;
    }

    /* overlay å­—å¹•å¡ï¼šå¡ç‰Œåœ¨å·¦ã€èªªæ˜åœ¨å³ */
    .overlay{
      position:relative;  /* è®“ winner-banner çµ•å°å®šä½ä»¥å­—å¹•å¡ç‚ºåŸºæº– */
      display:flex;
      gap:16px;
      align-items:flex-start;
      background: linear-gradient(180deg,#ffffff,#f6fbff);
      border-radius: 16px;
      border: 2px solid rgba(78,161,255,.10);
      padding: 16px;
      box-shadow: var(--card-shadow);
      overflow:visible;   /* è®“èŠ±ç“£å¯ä»¥è¶…å‡ºæŠ½å¡å€åŸŸä¸€äº› */
    }
    /* èŠ±ç“£æ‰€åœ¨çš„é€æ˜è¦†è“‹å±¤ */
.overlay-petal-layer{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:2;
  overflow:hidden;
}

/* æŠŠå·¦ã€å³å…©é‚Šå…§å®¹è“‹åœ¨èŠ±ç“£ä¸Šé¢ */
.overlay-left,
.overlay-right{
  position:relative;
}

/* å–®ç‰‡èŠ±ç“£ */
.overlay-petal{
  position:absolute;
  width:32px;
  height:32px;
  background-image:url("petal.png"); /* å’Œ .html åŒè³‡æ–™å¤¾ */
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
  opacity:0;
  inset:0;
  pointer-events:none;   /* é¿å…æ“‹åˆ°é»æ“Š */
  z-index:5;             /* æ¯”å·¦å³å…§å®¹é«˜å°±å¥½ */

  /* å°å°ç«‹é«”æ„Ÿ */
  filter: drop-shadow(0 0 4px rgba(0,0,0,.18));

  animation: overlayPetalPath var(--dur, 14s) linear forwards;
  animation-delay: var(--delay, 0s);
}

/* èŠ±ç“£æ—é‚Šçš„å° â™¥ / â­‘ ç«èŠ± */
.petal-spark {
  position: absolute;
  transform: translate(-50%, -50%);
  font-size: var(--sparkSize, 2px);
  color: #ffe3fa;

  /* ç™¼å…‰æ•ˆæœ */
  text-shadow:
    0 0 2px  #ffe3fa,
    0 0 4px  #fde9ff,
    0 0 8px  #ff7fc1,
    0 0 14px #ff46a6;

  filter: drop-shadow(0 0 4px #ff7fc1);
  opacity: 0;
  pointer-events: none;

  /* é–ƒçˆå‹•ç•«ï¼šæ™‚é–“èˆ‡å»¶é²ç”¨ JS å¡çš„è®Šæ•¸ */
    animation-name: sparkBlink;
  animation-timing-function: cubic-bezier(0.2, 0.8, 0.3, 1); /* é€Ÿåº¦æ„Ÿå¯ä»¥è‡ªå·±æ”¹ */
  animation-duration: var(--sparkDur, 900ms);
  animation-delay: var(--sparkDelay, 0ms);
  animation-iteration-count: 2;          /* æ’­ä¸€æ¬¡å°±å¥½ */
  animation-fill-mode: forwards;         /* çµæŸæ™‚ç¶­æŒåœ¨æœ€å¾Œä¸€æ ¼ï¼ˆé€æ˜ï¼‰ */

}

/* è®“ pink / blue å…©ç¨®çœ‹èµ·ä¾†ç¨å¾®ä¸ä¸€æ¨£ */
.petal-spark.pink {
  color: #ffe3fa;
}
.petal-spark.blue {
  color: #BBFFEE;
}


/* â™¥ / â­‘ å¾èŠ±ç“£ä¸­å¿ƒå¾€å¤–å™´å°„çš„å‹•ç•« */
@keyframes sparkBlink {
  0% {
    opacity: 0;
    transform:
      translate(-50%, -50%)
      scale(calc(var(--sparkScale, 1) * 0.4));
    text-shadow:
      0 0 1px  #ffe3fa,
      0 0 2px  #bfe7ff,
      0 0 4px  #7fd3ff,
      0 0 6px  #46b5ff;
  }

  10% {
    /* å‰›å™´å‡ºçš„ç¬é–“ï¼Œäº®ä¸€ä¸‹ */
    opacity: 1;
    transform:
      translate(-50%, -50%)
      scale(calc(var(--sparkScale, 1) * 0.9));
    text-shadow:
      0 0 3px  #ffe3fa,
      0 0 6px  #e3f5ff,
      0 0 12px #aee4ff,
      0 0 20px #74c9ff;
  }

  60% {
    /* ä¸­æ®µï¼šé£›åˆ°å¤§æ¦‚ 70% çš„è·é›¢ */
    opacity: 0.9;
    transform:
      translate(
        calc(-50% + 0.7 * var(--sparkDx, 0px)),
        calc(-50% + 0.7 * var(--sparkDy, 0px))
      )
      scale(calc(var(--sparkScale, 1) * 1.1));
  }

  100% {
    /* çµæŸï¼šé£›åˆ°æŒ‡å®šä½ç½®ï¼Œæ¼¸æ¼¸æ¶ˆå¤± */
    opacity: 0;
    transform:
      translate(
        calc(-50% + var(--sparkDx, 0px)),
        calc(-50% + var(--sparkDy, 0px))
      )
      scale(calc(var(--sparkScale, 1) * 1.2));
    text-shadow:
      0 0 0px  #ffe3fa,
      0 0 0px  #bfe7ff,
      0 0 0px  #7fd3ff,
      0 0 0px  #46b5ff;
  }
}


/* èŠ±ç“£è·¯å¾‘ï¼šå³ä¸‹ âœ å·¦ä¸Šï¼Œé›™ Sï¼ˆ4 å€‹å½ï¼‰ç‰ˆæœ¬ */
@keyframes overlayPetalPath{
  0%{
    opacity:0;
    transform:
      translate3d(0, 0, 0)
      rotate(var(--r0, 0deg));
  }

  /* æ…¢æ…¢é€²å ´ï¼‹æ·¡å…¥ */
  8%{
    opacity: var(--alpha, .55);
    transform:
      translate3d(
        calc(var(--dx, 120px) * -0.12),
        calc(var(--dy, 160px) * -0.08),
        0
      )
      rotate(calc(var(--r0, 0deg) + 4deg));
  }

  /* ç¬¬ 1 å½ï¼šå¾€å·¦ä¸Šæ‹‰å‡ºå» */
  20%{
    transform:
      translate3d(
        calc(var(--dx, 120px) * -0.70),   /* å¾ˆå¾€å·¦ */
        calc(var(--dy, 160px) * -0.25),   /* é–‹å§‹å¾€ä¸Š */
        0
      )
      rotate(calc(var(--r0, 0deg) + 20deg));
  }

  /* ç¬¬ 2 å½ï¼šå¾€å³æ”¶å›ä¸€é»ï¼ˆå½¢æˆç¬¬ä¸€å€‹ Sï¼‰ */
  35%{
    transform:
      translate3d(
        calc(var(--dx, 120px) * -0.25),   /* X å¾€å³å›ä¾† */
        calc(var(--dy, 160px) * -0.45),   /* ç¹¼çºŒå¾€ä¸Š */
        0
      )
      rotate(calc(var(--r0, 0deg) + 6deg));
  }

  /* ç¬¬ 3 å½ï¼šå†ä¸€æ¬¡å¾€å·¦ï¼ˆç¬¬äºŒå€‹ S çš„å‰åŠï¼‰ */
  50%{
    transform:
      translate3d(
        calc(var(--dx, 120px) * -1.25),   /* åˆå¾€å·¦ç”©å‡ºå» */
        calc(var(--dy, 160px) * -0.65),
        0
      )
      rotate(calc(var(--r0, 0deg) + 18deg));
  }

  /* ç¬¬ 4 å½ï¼šå†å¾€å³æ”¶ä¸€é»ï¼Œå®Œæˆç¬¬äºŒå€‹ S */
  65%{
    transform:
      translate3d(
        calc(var(--dx, 120px) * -0.40),   /* å†å¾€å³ä¸€äº› */
        calc(var(--dy, 160px) * -0.85),
        0
      )
      rotate(calc(var(--r0, 0deg) + 2deg));
  }

  /* å‡ºç•«é¢å‰æœ€å¾Œå†å¾€å·¦æ‹‰ä¸€æ¬¡ï¼Œå¾€å·¦ä¸Šè§’é£›èµ° */
  80%{
    opacity: var(--alpha, .55);
    transform:
      translate3d(
        calc(var(--dx, 120px) * -1.45),
        calc(var(--dy, 160px) * -1.05),
        0
      )
      rotate(calc(var(--r0, 0deg) - 10deg));
  }

  100%{
    opacity:0;
    transform:
      translate3d(
        calc(var(--dx, 120px) * -1.65),   /* ç¨å¾®å†é£›é ä¸€é» */
        calc(var(--dy, 160px) * -1.20),
        0
      )
      rotate(var(--r1, 180deg));
  }
}

    .overlay-left{
      flex:0 0 210px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .overlay-right{
      flex:1;
      min-width:0;
    }

    .overlay-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }

    .overlay-title{
      font-size: 34px;
      font-weight: 900;
      color: var(--accent);
      margin:0;
      text-shadow: 0 2px 0 rgba(255,255,255,.8);
    }

        .overlay-badge{
      flex:0 0 auto;
      max-width:260px;
      padding:4px 12px;
      border-radius:999px;
      background:linear-gradient(90deg,#ffe4f2,#ffd1e6);
      color:#9c2955;
      font-size:13px;
      font-weight:700;
      box-shadow:0 4px 10px rgba(255,105,180,.25);
      border:1px solid rgba(255,140,190,.55);
      overflow:hidden;          /* æ–‡å­—å¾€ä¸Šæ»‘æ™‚ä¸æº¢å‡º */
      white-space:nowrap;
    }
    .overlay-badge.hidden{
      display:none;
    }

    /* æ–‡å­—å¾ä¸‹å¾€ä¸Šæ»‘å…¥ä¸€æ¬¡ï¼Œåœåœ¨åŸä½ */
    .overlay-badge-text{
      display:inline-block;
      transform: translateY(100%);
      opacity:0;
      animation: overlayBadgeEnter 600ms ease-out forwards;
    }

    @keyframes overlayBadgeEnter{
      0%{
        transform: translateY(100%);
        opacity:0;
      }
      60%{
        transform: translateY(0);
        opacity:1;
      }
      100%{
        transform: translateY(0);
        opacity:1;
      }
    }



    .overlay-lines{
      display:flex;
      flex-direction:column;
      gap:4px;
      color:var(--text);
      font-size:16px;
      margin-bottom:4px;
    }
    .overlay-players{
      margin-top:6px;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .avatar-sm{
      width:32px; height:32px;
      border-radius:10px;
      border:2px solid #fff;
      box-shadow: 0 6px 14px rgba(30,60,120,.08);
      overflow:hidden;
      background:#fff;
    }
    .overlay-player{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      min-width:40px;
    }
    .overlay-step-badge{
      padding:1px 6px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      border:1px solid rgba(78,161,255,.25);
      font-size:11px;
      font-weight:700;
      color:var(--accent);
      box-shadow:0 2px 4px rgba(30,60,120,.18);
    }

    .avatar-sm img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .overlay-note{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
    }

    /* card (æŠ½å¡) */
    .card-area{
      width:120px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      /* æ–°å¢é€™è¡Œï¼Œè®“èŠ±ç“£å¯ä»¥ä»¥å®ƒç•¶åŸºæº– */
      position:relative;
    }
    .card{
      width:100%;
      padding-top:130%;   /* 4:5 æ¯”ä¾‹ */
      position:relative;
      transform-style:preserve-3d;
      transition: transform 560ms ease;
    }
    .card.flip{ transform: rotateY(180deg) scale(1.03); }
    .card-face{
      position:absolute; inset:0;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      backface-visibility:hidden;
      border: 2px solid rgba(78,161,255,.10);
    }
    .card-back{
      background: linear-gradient(180deg,#eaf6ff,#dbf0ff);
      color:var(--accent);
      font-size:26px;
    }
    .card-front{
      background: linear-gradient(180deg,#4ea1ff,#79c8ff);
      color:#fff;
      transform:rotateY(180deg);
      font-size:28px;
    }
    .card-hint{
      color:var(--muted);
      font-size:13px;
    }

    /* å† è»æ©«å¹…ï¼ˆæ”¹ï¼šæ”¾åœ¨å­—å¹•å¡å³ä¸‹è§’ï¼Œæ¬¾å¼ä¸è®Šä½†æ”¾å¤§ï¼‰ */
.winner-banner{
  position:absolute;

  /* âœ… å°é½Šå­—å¹•å¡å³ä¸‹ */
  right: 16px;
  bottom: 14px;
  left: auto;
  top: auto;

  /* âœ… æ¬¾å¼ä¸è®Šï¼šæ²¿ç”¨ä½ çš„è‰²ç³»èˆ‡é™°å½± */
  padding:10px 30px;
  border-radius:999px;
  background:linear-gradient(90deg,#fff3c4,#ffe08a);
  box-shadow:0 10px 30px rgba(255,183,3,.35);
  border:1px solid rgba(255,183,3,.6);
  font-weight:900;
  font-size:18px;
  color:#8a5a00;
  letter-spacing:0.08em;
  display:flex;
  align-items:center;
  gap:8px;

  /* âœ… æ•´é«”æ”¾å¤§ï¼ˆåªæ”¾å¤§ï¼Œä¸æ”¹æ¬¾å¼ï¼‰ */
  transform: scale(1.35);
  transform-origin: right bottom;

  opacity:0;
  pointer-events:none;
  z-index:90;
}


    .winner-banner.show{
      animation:winnerBannerIn 900ms cubic-bezier(0.18,0.9,0.2,1) forwards;
    }

    .winner-banner.fadeout{
      animation:winnerBannerOut 420ms ease-in forwards;
    }

    @keyframes winnerBannerIn{
  0%{
    opacity:0;
    transform: scale(1.10);
  }
  55%{
    opacity:1;
    transform: scale(1.45);
  }
  100%{
    opacity:1;
    transform: scale(1.35);
  }
}

@keyframes winnerBannerOut{
  0%{
    opacity:1;
    transform: scale(1.35);
  }
  100%{
    opacity:0;
    transform: scale(1.10);
  }
}


    /* å† è»è³½é“é«˜äº®ï¼ˆæ˜Ÿæ˜Ÿé‡‘å…‰å¤–æ¡†ç‰ˆï¼‰â”€å¾€å¤–ä¸€åœˆï¼Œæ•´æ¢é¸æ‰‹è³½é“å¤–æ¡† */
.lane.winner{
  position: relative;             /* çµ¦ ::before å®šä½ */
  z-index: 2;                     /* æ¯”å…¶å®ƒè³½é“é«˜ä¸€é» */
}

/* å¤–å±¤é‡‘è‰²å…‰æšˆæ¡†ï¼šåŒ…ä½æ•´æ¢ .laneï¼ˆå«æ·ºè—è³½é“é‚£åœˆï¼‰ */
.lane.winner::before{
  content: "";
  position: absolute;
  inset: -4px;                    /* å¾€å¤–æ“´ä¸€åœˆ */
  border-radius: 999px;
  pointer-events: none;

  border: 2px solid #ffd957;      /* é‡‘è‰²å¤–æ¡† */
  box-shadow:
    0 0 3px  rgba(255, 230, 150, .7),
    0 0 9px  rgba(255, 210,  90, .5);

  /* å…§éƒ¨äº®é» */
background:
  radial-gradient(circle at 20% 0%,   rgba(255,255,255,0.9), transparent 55%),
  radial-gradient(circle at 80% 100%, rgba(255,240,180,0.9), transparent 55%);

opacity: 0.7;
mix-blend-mode: screen;
animation: winnerGlow 2200ms ease-in-out infinite;
}


/* å¤–æ¡†ä¸€å‘¼ä¸€å¸åœ°é‡‘å…‰è„ˆå‹•ï¼ˆæ²¿ç”¨èˆŠçš„ï¼‰ */
@keyframes winnerGlow{
  0%, 100%{
    box-shadow:
      0 0 3px  rgba(255, 230, 150, .6),
      0 0 7px  rgba(255, 210,  90, .4);
  }
  50%{
    box-shadow:
      0 0 5px  rgba(255, 248, 210, .95),
      0 0 12px rgba(255, 210,  90, .7);
  }
}

/* äº®é»é–ƒçˆï¼ˆå¦‚æœè¦ä¿ç•™åŸä¾†çš„ winnerFlashï¼Œå¯ä»¥ç”¨é€™å€‹ï¼‰ */
@keyframes winnerFlash{
  0%, 100%{
    opacity: .3;
    transform: scale(1);
  }
  50%{
    opacity: 1;
    transform: scale(1.03);
  }
}



/* æ˜Ÿæ˜Ÿçˆ†ç‚¸ç²’å­ï¼ˆæ›´äº®ã€æ›´å¤§é¡†ï¼‰ */
.star-explode {
  position: absolute;
  pointer-events: none;
  opacity: 0;

  font-size: 12px;             /* å†æ”¾å¤§ä¸€é» */
  line-height: 1;
  color: #ffd75e;              /* é‡‘é»ƒè‰²æ˜Ÿæ˜Ÿ */
  text-shadow:
    0 0 6px  rgba(255,255,255,1),
    0 0 16px rgba(255,210, 90,1),
    0 0 28px rgba(255,210, 90,.9);

  z-index: 130;                /* å£“åœ¨æœ€ä¸Šå±¤ */
  animation: star-explode 900ms ease-out forwards;
}

@keyframes star-explode {
  0% {
    transform: translate(0, 0) scale(0.5) rotate(0deg);
    opacity: 1;
  }
  50% {
    opacity: 1;
    transform: translate(
      calc(var(--dx) * 0.6),
      calc(var(--dy) * 0.6)
    ) scale(1.15) rotate(150deg);
  }
  100% {
    transform: translate(var(--dx), var(--dy)) scale(1.05) rotate(230deg);
    opacity: 0;
  }
}



    /* lanesï¼šè³½é“åˆ—è¡¨ */
    .lanes-wrap{
      flex:1;
      background: linear-gradient(180deg,#eef4ff,#f7fbff);
      border-radius: 14px;
      padding: 8px 8px 10px;
      overflow-y:auto;
    }
    .lanes-header{
      font-size:13px;
      color:var(--muted);
      margin:0 4px 12px;
    }

    .lane{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 6px;   /* è³½é“çš„é«˜åº¦ */
      border-radius:999px;
      background:#fff;
      box-shadow: 0 4px 10px rgba(78,161,255,.04);
      margin-bottom:12px;  /* è³½é“çš„é«˜åº¦ */
      transition: transform .16s ease, box-shadow .16s ease, opacity .12s ease;
    }
    .lane-info{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 140px;    /* è®“è³½é“è·Ÿåå­—ä¹‹é–“çš„ç•™ç™½ */
      min-width:140px;
    }
    .lane-order{
      width:26px;
      text-align:right;
      font-weight:700;
      color:var(--muted);
      font-variant-numeric: tabular-nums;
    }
    .lane-avatar-static{
      width:32px; height:32px;
      border-radius:999px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(78,161,255,.18);
    }
    .lane-avatar-static img{
      width:100%; height:100%; object-fit:cover;
    }
    .lane-name{
      font-weight:700;
    }

    .lane-track{
      position:relative;
      flex:1;
      height:34px;
      border-radius:999px;
      background: rgba(78,161,255,.06);
      overflow:visible;
    }
    .lane-bar{
      position:absolute;
      inset:0;
      border-radius:inherit;
      overflow:hidden;
      z-index:1;
    }
    .lane-bar-fill{
      position:absolute;
      left:0; top:0; bottom:0;
      width:0%;
      background: linear-gradient(90deg,#4ea1ff,#8bd3ff);
      border-radius:inherit;
    }
        /* èµ·é» / çµ‚é»å…±åŒçš„å®¹å™¨ */
.lane-line{
  position:absolute;
  top:50%;
  transform:translate(-50%,-50%);
  height:130%;
  width:20px;             /* çµ‚é»æ——å­çš„å¯¬åº¦ï¼Œå¯ä¾åœ–ç‰‡èª¿æ•´ */
  pointer-events:none;
  z-index: 2;
}

/* START åªæ˜¯ä¸€æ¢ç´°ç·š */
.lane-line-start{
  width:2px;
  background:#ffd166;
}

/* çµ‚é»æ——ï¼šç”¨åœ–ç‰‡ + è®Šç˜¦ä¸€é» */
.lane-line-finish{
  border:none;
  width:24px;            /* åŸæœ¬ 16 æˆ– 20ï¼Œæ”¹æˆ 10ï½12 éƒ½å¯ä»¥ */
  background-image:url("finish.png");
  background-repeat:no-repeat;
  background-position:center;
  background-size:100% 100%;         /* è®“åœ–ç‰‡å¡æ»¿é€™å€‹çª„çª„çš„å€å¡Š */
}


/* START / FINISH æ¨™ç±¤æ–‡å­—ï¼ˆå…©å€‹å…±ç”¨ï¼‰ */
.lane-line-label{
  position:absolute;
  top:-14px;
  left:50%;
  transform:translateX(-50%);
  font-size:9px;             /* START / FINISH åŒä¸€å€‹å­—ç´š */
  font-weight:700;
  letter-spacing:0.18em;
  background:transparent;
  padding:0;
  border-radius:0;
  box-shadow:none;
  white-space:nowrap;
}

/* é¡è‰²å¦‚æœæƒ³åˆ†é–‹ï¼Œä¹Ÿå¯ä»¥é¡å¤–åŠ ï¼š */
.lane-line-start .lane-line-label{
  color:#e53935;             /* STARTï¼šç´…è‰² */
}
.lane-line-finish .lane-line-label{
  color:#555;                /* FINISHï¼šç°è‰² */
}



    .lane-marker{
      position:absolute;
      overflow: visible;
      top:50%;
      width:32px; height:32px;
      border-radius:999px;
      transform:translate(-50%,-50%);
      background:transparent;
      border:none;
      box-shadow:none;
      z-index:3;
    }
    .lane-marker img{
      width:100%; height:100%; object-fit:cover;border-radius:999px;display:block;box-shadow: 0 6px 14px rgba(30,60,120,.12);
    }
/* ====== ç«¶é€Ÿï¼šGO ç«ç„°åœˆ + é ­åƒè„ˆè¡ ====== */
.lane-marker.rivalry-hot{
  z-index: 30;  /* ä¿æŒåœ¨å…¶å®ƒè³½é“å…ƒç´ ä¹‹ä¸Š */
}

/* è®“ã€Œé ­åƒã€æœ‰è‡ªå·±çš„å±¤ç´šï¼ˆåœ¨ç«ç„°ä¹‹ä¸Šï¼‰ */
.lane-marker.rivalry-hot img{
  position: relative;
  z-index: 1;                /* é ­åƒ > ç«ç„°ï¼ˆç«ç„°æœƒè¨­æˆ -1ï¼‰ */
  transform-origin: 50% 65%;
  animation: rivalPulse 780ms ease-in-out infinite;
  will-change: transform, filter;
}

/* ç«ç„°åœˆï¼šåƒå…‰ç’°ä¸€æ¨£ç¹åœ¨é ­åƒå¤–é¢ä¸€åœˆ */
.lane-marker.rivalry-hot::after{
  content:"";
  position:absolute;
  left:50%;
  top:50%;

  /* å…‰ç’°å°ºå¯¸ï¼šæ¯” 32x32 çš„é ­åƒå¤§ä¸€é» */
  width: 52px;
  height: 52px;
  border-radius:50%;

  /* ä»¥é ­åƒä¸­å¿ƒç‚ºåŸºæº–ï¼Œå®Œå…¨ç½®ä¸­ */
  transform: translate(-50%, -50%) scale(0.9);
  transform-origin: 50% 50%;

  pointer-events:none;
  z-index:-1;  /* é ­åƒåœ¨ä¸Šå±¤ï¼Œå…‰ç’°åœ¨ä¸‹å±¤ */

  /* ä¸­é–“é€æ˜ â†’ å¤–åœˆäº® â†’ æœ€å¤–é¢å†é€æ˜ï¼Œåšæˆã€Œåœˆã€ */
  background:
    radial-gradient(circle,
      rgba(255,255,255,0.0) 0%,    /* ä¸­å¿ƒé€æ˜ */
      rgba(255,255,255,0.0) 45%,
      rgba(255,236,160,0.95) 60%,  /* å…‰ç’°æœ€äº®çš„åœ°æ–¹ */
      rgba(255,170,60,0.65) 75%,
      rgba(255,120,30,0.00) 92%);  /* å¤–åœæ…¢æ…¢æ·¡æ‰ */

  /* æŸ”ä¸€é»çš„ç™¼å…‰ */
  filter:
    blur(0.6px)
    drop-shadow(0 0 6px rgba(255,220,120,0.55))
    drop-shadow(0 0 14px rgba(255,140,40,0.35));

  opacity:0.85;

  /* è·Ÿé ­åƒåŒç¯€å¥å‘¼å¸ */
  animation: flamePulse 780ms ease-in-out infinite;
  will-change: transform, opacity, filter;
}


/* é ­åƒè„ˆè¡ï¼šæ”¾å¤§ â†’ å›ä¾† â†’ å†æ”¾å¤§ â†’ å›ä¾† */
@keyframes rivalPulse{
  0%   { transform: scale(1.00); }
  18%  { transform: scale(1.14); }
  38%  { transform: scale(1.02); }
  58%  { transform: scale(1.12); }
  78%  { transform: scale(1.00); }
  100% { transform: scale(1.00); }
}

/* ç«ç„°è„ˆè¡ï¼šå¹…åº¦ç¸®å°ä¸€é»ï¼Œæ•´é«”æ¯”è¼ƒä¸èª‡å¼µ */
@keyframes flamePulse{
  0%{
    transform: translate(-50%, -4%) scale(0.85);
    opacity: 0.75;
    filter: blur(0.8px)
            drop-shadow(0 0 5px rgba(255,220,120,0.35))
            drop-shadow(0 0 10px rgba(255,140,40,0.22));
  }
  18%{
    transform: translate(-50%, -5%) scale(1.03);
    opacity: 0.96;
  }
  38%{
    transform: translate(-50%, -4%) scale(0.95);
    opacity: 0.85;
  }
  58%{
    transform: translate(-50%, -6%) scale(1.02);
    opacity: 0.93;
  }
  78%{
    transform: translate(-50%, -4%) scale(0.87);
    opacity: 0.80;
  }
  100%{
    transform: translate(-50%, -4%) scale(0.85);
    opacity: 0.75;
  }
}

    /* è³½é“ä¸Šçš„å† è»çš‡å† ï¼ˆé ­é ‚ä¸­é–“ï¼‰ */
.lane-crown{
  position:absolute;
  left:50%;
  top:-1px;                        /* è¶Šå°è¶Šå¾€ä¸Š */
  transform:
    translate(-60%, -50%)          /* X,Y ä½ç½®å¾®èª¿ */
    rotate(-15deg)
    scale(0.9);
  transform-origin: bottom center;
  font-size:15px;                  /* çš‡å† å¤§å° */
  pointer-events:none;
  opacity:0;
  z-index:4;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,.18));
  transition: opacity 220ms ease-out, transform 220ms ease-out;
}

.lane-crown.show{
  opacity:1;
  transform:
    translate(-60%, -50%)          /* é¡¯ç¤ºæ™‚å†æŠ¬é«˜ã€æ”¾å¤§ä¸€é» */
    rotate(-18deg)
    scale(1.15);
}

/* ===== å®Œæˆå¾Œç‹€æ…‹ï¼šæœªå† è»å®Œæˆè€…çš„è¦–è¦º ===== */

/* å·²å®Œæˆï¼šåŸºæœ¬å…‰æšˆ */
.lane-marker.finished{
  filter: drop-shadow(0 0 10px rgba(255,200,80,.95));
}

/* æ˜Ÿå…‰é»é»ï¼ˆåœ–ç‰‡1é¢¨æ ¼ï¼‰ */
.lane-marker.star-power::after{
  content:"âœ¦ âœ§ âœ¦ âœ§";
  position:absolute;
  inset:-10px;
  font-size:12px;
  color:#ffd75e;
  opacity:.0;
  animation: starTwinkle .8s linear infinite;
  pointer-events:none;
}

@keyframes starTwinkle{
  0%   { opacity:.15; transform:rotate(0deg); }
  50%  { opacity:1; }
  100% { opacity:.25; transform:rotate(360deg); }
}

/* å½©è‰²æ®˜å½±æ‹–å°¾ï¼š>FINISH æ™‚å‡ºç¾çš„å½©è™¹å…‰æŸï¼ˆé…åˆç«ç®­ï¼‰ */
.lane-marker.rainbow-power::before{
  content:"";
  position:absolute;
  top:50%;
  right:50%;  /* è®“å…‰æŸä¸»è¦å¾€é ­åƒå·¦å¾Œæ–¹å»¶ä¼¸ */
  width:80px;
  height:32px;
  border-radius:32px;
  transform:
    translate(10px, -50%)
    skewX(-18deg)
    scaleX(0.9);
  background:linear-gradient(
    90deg,
    rgba(255, 0, 150, .75),
    rgba(0, 255, 255, .75),
    rgba(255, 255, 0, .85)
  );
  filter: blur(6px);
  opacity:0;
  z-index:-1;          /* åœ¨é ­åƒå¾Œé¢ï¼Œä¸æœƒè“‹ä½è‡‰ */
  pointer-events:none;
  animation: rainbowTrail .6s linear infinite;
}

/* å½©è™¹æ‹–å°¾å‘¼å¸ï¼‹ä½ç§»ï¼Œç‡Ÿé€ æ®˜å½±æ„Ÿ */
@keyframes rainbowTrail{
  0%{
    opacity:.3;
    transform:
      translate(12px, -50%)
      skewX(-18deg)
      scaleX(0.85);
  }
  50%{
    opacity:1;
    transform:
      translate(0px, -50%)
      skewX(-18deg)
      scaleX(1.05);
  }
  100%{
    opacity:.35;
    transform:
      translate(-12px, -50%)
      skewX(-18deg)
      scaleX(0.9);
  }
}


/* ğŸš€ å®¹å™¨ï¼ˆåœ¨é¸æ‰‹æ—é‚Šï¼‰ */
.lane-rocket{
  position:absolute;
  right:-22px;
  top:50%;
  transform:translateY(-50%);
  font-size:20px;
  pointer-events:none;
  animation: rocketBob 600ms ease-in-out infinite alternate;
}



@keyframes rocketBob{
  from{ transform:translateY(-50%) translateY(0); }
  to{ transform:translateY(-50%) translateY(-4px); }
}

@keyframes sparkTwinkle{
  0%{ opacity:.3; }
  50%{ opacity:1; }
  100%{ opacity:.4; }
}



    /* ç›®å‰æ ¼æ•¸æ¨™ç±¤ ğŸ¾ + æ•¸å­—ï¼ˆè²¼åœ¨é ­åƒå·¦å´ï¼Œç´”æ–‡å­—ï¼‰ */
    .lane-pos-label{
  position:absolute;
  top:100%;                     /* åŸºæº–ï¼šé ­åƒæ­£ä¸‹æ–¹ */
  left:50%;
  transform:translate(-50%, -4px);  /* å¾€ä¸Šæ‹‰ 2pxï¼Œè¶Šè² è¶Šé è¿‘é ­åƒ */
  font-size:11px;
  color:var(--muted);
  font-variant-numeric: tabular-nums;
  display:flex;
  align-items:center;
  gap:4px;
  font-weight:700;
  padding:0;
  border-radius:0;
  background:transparent;       /* åº•è‰²é€æ˜ */
  box-shadow:none;
  white-space:nowrap;
}
/* è¶…éçµ‚é»æ™‚ï¼šæŠŠ X æ ¼ç§»åˆ°ç«ç®­åº•ä¸‹ */
.lane-pos-label.beyond-finish{
  left:100%;                    /* ä»¥é ­åƒå³é‚Šç‚ºåŸºæº– */
  transform:translate(-10%, -4px); /* ç¨å¾®å¾€å·¦ä¸€é»ï¼Œçœ‹èµ·ä¾†åœ¨ç«ç®­ä¸‹æ–¹ */
}


    .lane.dim{ opacity:.25; }
    .lane.focus{
      transform: translateY(-2px);
      box-shadow: 0 0 0 3px rgba(78,161,255,.25);
    }

    /* side barï¼šå³å´å³æ™‚åæ¬¡ */
    .sidebar{
      background: linear-gradient(180deg,#ffffff,#fbfdff);
      border: 2px solid rgba(78,161,255,.06);
      border-radius: 14px;
      padding:12px;
      box-shadow: var(--card-shadow);
      height: fit-content;
    }
    .clear-section{
  margin-bottom:10px;
  padding-bottom:8px;
  border-bottom:2px solid rgba(78,161,255,.08);
}
.clear-section h2{
  color:#1b2a4a;
}
/* ğŸ”¹ é€šé—œï¼å³æ™‚æ’åï¼šæŸ”å’Œä¸€é»çš„æ·¡éœ§è—åº•å¡ç‰‡ */
.rank-section{
  margin-top:8px;
  padding:10px 10px 12px;
  border-radius:12px;
  /* æ¯” sidebar ç¨å¾®è—ä¸€é»ï¼Œä½†ç¶­æŒå¾ˆæ·¡ */
  background: linear-gradient(180deg,#f9fbff,#edf3ff);
  border:1px solid rgba(78,161,255,.12);
  box-shadow: 0 6px 12px rgba(30,60,120,.06);
}

/* å…©å€‹æ’åå€å¡Šä¹‹é–“çš„è·é›¢ */
.rank-section + .rank-section{
  margin-top:12px;
}

/* å¡ç‰‡è£¡çš„æ¨™é¡Œã€èªªæ˜ã€åˆ—è¡¨ç´°ç¯€ */
.rank-section h2{
  margin:4px 0 6px;
  color: var(--accent);
  font-size:18px;
}
.rank-section .rank-note{
  margin-bottom:8px;
}
.rank-section .rank{
  padding-left:0;
}

/* è®“ç™½è‰² li åœ¨æ·¡è—åº•ä¸Šä»ç„¶æ¸…æ¥šï¼Œä½†ä¸æœƒå¤ªé‡ */
.rank-section .rank li{
  background:#ffffff;
  border:1px solid rgba(255,255,255,.7);
}



    /* å³å´ï¼šå›åˆå¿«é€Ÿè·³è½‰å€å¡Š */
    .round-jump{
      margin-bottom:10px;
      padding:6px 8px;
      border-radius:10px;
      background:rgba(78,161,255,.04);
      border:1px solid rgba(78,161,255,.08);
    }

    .round-jump-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .round-jump-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    .round-jump-btn{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(78,161,255,.3);
      background:rgba(255,255,255,.9);
      cursor:pointer;
    }

    .round-jump-btn:hover{
      background:rgba(78,161,255,.06);
    }

    .sidebar h2{ margin:6px 0 8px; color:var(--accent); font-size:18px; }
    .rank-note{ font-size:13px; color:var(--muted); margin-bottom:10px; }
    .rank{
      margin:0;
      padding-left: 4px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .rank li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
      border-radius:10px;
      padding:8px;
      border:1px solid rgba(78,161,255,.04);
    }

    /* åæ¬¡æ»‘å‹•æ›ä½ï¼ˆFLIPï¼‰ç”¨ï¼šè®“ li å¹³æ»‘å›å½ˆ */
/* è®“å…‰æ¾¤è¢«å¡ç‰‡é‚Šç•Œè£æ‰ï¼Œåªäº®åœ¨å³æ™‚æ’åé‚£ä¸€æ ¼è£¡ */
.rank li{
  position: relative;
  overflow: hidden;  /* å¾ˆé‡è¦ï¼šæŠŠ ::before çš„å…‰æ¾¤é™åˆ¶åœ¨ li è£¡é¢ */
}

/* ğŸ”¹ åæ¬¡ä¸Šå‡ï¼šå…§ç™¼å…‰ + æƒå…‰æ¢ */
.rank li.rank-up-glow{
  animation: rankGlowPulse 900ms ease-out;
}

/* æƒéå»çš„äº®æ¢ï¼ˆé›†ä¸­åœ¨å¡ç‰‡è£¡ï¼‰ */
.rank li.rank-up-glow::before{
  content:"";
  position:absolute;
  inset:-2px;                 /* æ¯” li å†å¤§ä¸€é»é»ï¼Œé‚Šç·£æ‰ä¸æœƒéœ²å‡ºç¸« */
  border-radius:inherit;
  pointer-events:none;
  mix-blend-mode:screen;

  /* æ›´å¼·çƒˆçš„é‡‘å±¬å…‰æ¾¤ï¼šä¸­é–“ç™½å…‰ï¼‹è—ç¶ è‰² */
  background:linear-gradient(
    115deg,
    rgba(255,255,255,0.0) 0%,
    rgba(255,255,255,1.0) 16%,
    rgba(205,255,255,1.0) 30%,
    rgba(120,220,255,0.95) 42%,
    rgba(255,255,255,0.0) 63%
  );

  transform:translateX(-140%);
  opacity:0;
  animation: rankShineSweep 900ms ease-out forwards;
}

/* æ”¹æˆã€Œå…§ç™¼å…‰ã€ï¼Œä¸æœƒå†è·‘åˆ°å¤–é¢å» */
@keyframes rankGlowPulse{
  0%{
    box-shadow: inset 0 0 0 rgba(78,161,255,0);
  }
  40%{
    box-shadow: inset 0 0 14px rgba(78,161,255,0.95);
  }
  100%{
    box-shadow: inset 0 0 0 rgba(78,161,255,0);
  }
}

/* äº®æ¢å¾å·¦åˆ°å³æƒéå¡ç‰‡ä¸­é–“ */
@keyframes rankShineSweep{
  0%{
    transform:translateX(-140%);
    opacity:0;
  }
  15%{
    opacity:1;
  }
  100%{
    transform:translateX(140%);
    opacity:0;
  }
}

/* ğŸ”¹ åæ¬¡æŒå¹³ï¼šéŠ€è‰²é‡‘å±¬å…‰æ¾¤ + æƒå…‰æ¢ */
.rank li.rank-same-glow{
  /* è·Ÿ rank-up ä¸€æ¨£æ™‚é–“ï¼Œä½†ç”¨éŠ€è‰²å…§ç™¼å…‰ */
  animation: rankGlowPulseSilver 900ms ease-out;
}

/* åæ¬¡æŒå¹³ï¼šæ·¡ç´«é‡‘å±¬æƒå…‰æ¢ï¼ˆæ²¿ç”¨ rankShineSweep ä½ç§»ï¼‰ */
.rank li.rank-same-glow::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:inherit;
  pointer-events:none;
  mix-blend-mode:screen;

  /* æ·¡ç´«é‡‘å±¬å…‰æ¾¤ï¼šç™½ â†’ æ·ºè–°è¡£è‰ â†’ å¸¶ä¸€é»è—ç´« â†’ å†æ·¡å‡º */
  background:linear-gradient(
    115deg,
    rgba(255,255,255,0.0) 0%,
    rgba(255,255,255,1.0) 18%,
    rgba(237,229,255,1.0) 32%,   /* æ·ºè–°è¡£è‰ */
    rgba(195,166,255,0.95) 44%,  /* æ¯”è¼ƒæœ‰å­˜åœ¨æ„Ÿçš„ç´« */
    rgba(255,255,255,0.0) 65%
  );

  transform:translateX(-140%);
  opacity:0;
  animation: rankShineSweep 900ms ease-out forwards;
}


/* æ·¡ç´«å…§ç™¼å…‰ç‰ˆæœ¬ï¼ˆçµ¦åæ¬¡æŒå¹³ç”¨ï¼‰ */
@keyframes rankGlowPulseSilver{
  0%{
    box-shadow: inset 0 0 0 rgba(195,166,255,0);       /* ä¸€é–‹å§‹æ²’å…‰ */
  }
  40%{
    box-shadow: inset 0 0 14px rgba(195,166,255,0.95); /* ä¸­æ®µç´«è‰²ç™¼äº® */
  }
  100%{
    box-shadow: inset 0 0 0 rgba(195,166,255,0);       /* æ”¶å›å» */
  }
}



/* å³å´åæ¬¡è®Šå‹•å¾½ç« ï¼ˆâ†‘â†“ï¼‰ */
.rank-delta{
  margin-left:8px;
  font-size:12px;
  font-weight:900;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(78,161,255,.18);
  background: rgba(78,161,255,.06);
  color: var(--muted);
}
.rank-delta.up{
  background: rgba(74,214,109,.12);
  color:#157a3c;
  border-color: rgba(74,214,109,.25);
}
.rank-delta.down{
  background: rgba(255,107,107,.12);
  color:#b42323;
  border-color: rgba(255,107,107,.25);
}

    .rank .name{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .rank .name img{
      width:30px; height:30px; border-radius:999px;
    }
    /* åç¨±ï¼‹è®Šå‹•å¾½ç« çš„å®¹å™¨ */
.rank-name-wrap{
  display:flex;
  flex-direction:row;     /* åŸæœ¬æ˜¯ columnï¼Œæ”¹æˆ row å°±æœƒä¸¦æ’ */
  align-items:center;
  gap:6px;
  min-width:0;
}

.rank-title{
  font-weight:700;
  white-space:nowrap;     /* é¿å…æ›è¡Œåˆ†é–‹ */
}


    /* å³æ™‚æ’åï¼šé ­åƒå®¹å™¨ï¼ˆè®“çš‡å† å¯ä»¥å®šä½ï¼‰ */
.rank-avatar-wrap{
  position:relative;
  width:30px;
  height:30px;
  flex:0 0 30px;
}

.rank-avatar-wrap img{
  width:30px;
  height:30px;
  border-radius:999px;
  display:block;
}

/* ç¬¬ä¸€åçš‡å† ï¼šæˆ´åœ¨é ­é ‚åå³ä¸Š */
.rank-crown{
  position:absolute;
  left:50%;                     /* ä»¥é ­åƒä¸­å¿ƒç‚ºåŸºæº– */
  top:-1px;                     /* å¾€ä¸ŠæŠ¬ï¼Œæ•¸å­—è¶Šå°è¶Šé ä¸Š */
  transform:
    translate(-60%, -50%)       /* X å¾€å·¦ä¸€é»ã€Y å†å¾€ä¸Šäº› */
    rotate(-18deg)
    scale(0.95);
  transform-origin: bottom center;
  font-size:14px;
  line-height:1;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,.18));
  opacity:0;
  transition: opacity 180ms ease, transform 180ms ease;
  pointer-events:none;
}

.rank-crown.show{
  opacity:1;
  transform:
    translate(-60%, -50%)       /* é¡¯ç¤ºæ™‚å†æŠ¬é«˜ã€æ”¾å¤§ä¸€é» */
    rotate(-18deg)
    scale(1.1);
}


    .rank .pos{
      color:var(--muted);
      font-size:13px;
      font-variant-numeric: tabular-nums;
    }

    /* splash é–‹å ´èªªæ˜ */
    #splash{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:80;
      background: linear-gradient(90deg, rgba(30,60,120,.08), rgba(78,161,255,.04));
    }
    .splash-card{
      width:760px; max-width:92%;
      background:#fff;
      border-radius:16px;
      padding:20px;
      box-shadow: 0 30px 60px rgba(30,60,120,.12);
      border:1px solid rgba(78,161,255,.08);
      display:flex;
      gap:18px;
      align-items:center;
    }
    .splash-left{ flex:1; }
    .splash-title{
      font-size:26px;
      color:var(--accent);
      margin:0 0 8px;
      font-weight:900;
    }
    .splash-lines{
      color:var(--muted);
      line-height:1.6;
      font-size:14px;
    }
    .splash-right{
      width:220px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }

    /* ===== ç…™ç«ç‰¹æ•ˆï¼ˆç¬¬ä¸€åå‡ºç¾æ™‚ï¼‰ ===== */
    #fireworks .fw-spark{
  position:absolute;
  left:0; top:0;
  width: var(--sz, 6px);
  height: var(--sz, 6px);
  border-radius: 999px;
  background: radial-gradient(circle, rgba(255,255,255,.95), var(--clr));
  box-shadow:
    0 0 10px rgba(255,255,255,.7),
    0 0 18px var(--clr);
  opacity: 0;
  transform: translate(-50%, -50%);
  animation:
    fwPop 260ms ease-out forwards,
    fwFly var(--dur, 1100ms) cubic-bezier(0.18,0.7,0.2,1) forwards;
  animation-delay:
    var(--delay, 0ms),
    calc(var(--delay, 0ms) + 60ms);
  z-index: var(--z, 96);
}

@keyframes fwPop{
  0%   { opacity:0; transform: translate(-50%,-50%) scale(.2); }
  60%  { opacity:1; transform: translate(-50%,-50%) scale(1.25); }
  100% { opacity:1; transform: translate(-50%,-50%) scale(1); }
}

@keyframes fwFly{
  0%   { transform: translate(-50%,-50%) translate(0,0) scale(1); }
  70%  { opacity:1; }
  100% { transform: translate(-50%,-50%) translate(var(--dx), var(--dy)) scale(.85); opacity:0; }
}


    #itemFx{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:88;
    }



    /* æ–°çš„èŠ±ç“£è»Œè·¡ç‰¹æ•ˆï¼ˆå–ä»£åŸæœ¬ âœ¨ï¼‰ */
.track-star{
  position: fixed;
  left: var(--x, 50vw);
  top:  var(--y, -8vh);

  width: var(--size, 50px);
  height: var(--size, 50px);

  background-image: url("petal.png");
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;


  pointer-events: none;

  /* âœ… ä¿è­‰åœ¨ç•«é¢ä¸Šå±¤ */
  z-index: 120;

  opacity: 0;
  filter: blur(var(--blur, 0px))
    drop-shadow(0 0 6px rgba(0,0,0,.18)); /* è®“é‚Šç·£æ›´ç«‹é«”ä¸€é» */

  /* å…©æ®µå‹•ç•«ä¿æŒä¸è®Š */
  animation:
    petalFall var(--dur, 9s) linear forwards,
    petalSway var(--dur, 9s) ease-in-out forwards;
  animation-delay: var(--delay, 0s), var(--delay, 0s);

  will-change: transform, opacity;
}


/* ä¸‹è½ï¼‹æ·¡å‡ºï¼ˆæ·¡å‡ºæ”¾åœ¨æœ€å¾Œä¸€å°æ®µï¼Œé¿å…åƒå™´ç™¼ï¼‰ */
@keyframes petalFall{
  0%{
    opacity: 0;
    transform: translate3d(0, -10vh, 0) rotate(var(--r0, 0deg));
  }
  8%{
    opacity: var(--alpha, .55);
  }
  85%{
    opacity: var(--alpha, .55);
  }
  100%{
    opacity: 0;
    transform: translate3d(0, 115vh, 0) rotate(var(--r1, 180deg));
  }
}

/* æ…¢æ…¢å·¦â†’å³â†’å·¦ï¼ˆä½ è¦çš„ç¯€å¥ï¼‰ï¼‹é †ä¾¿è®“æ—‹è½‰æœ‰é»é£„æ„Ÿ */
@keyframes petalSway{
  0%{
    transform: translate3d(0, -10vh, 0) rotate(var(--r0, 0deg));
  }
  33%{
    transform: translate3d(calc(var(--drift, 40px) * -1), 30vh, 0) rotate(calc(var(--r0, 0deg) + 30deg));
  }
  66%{
    transform: translate3d(var(--drift, 40px), 70vh, 0) rotate(calc(var(--r0, 0deg) - 20deg));
  }
  100%{
    transform: translate3d(calc(var(--drift, 40px) * -1), 115vh, 0) rotate(var(--r1, 180deg));
  }
}


    /* ===== å¤©ä½¿ç‰¹æ•ˆï¼šangel-wing ç¾½æ¯›é£„è½ + äº®äº®æ„›å¿ƒæ³¡æ³¡ ===== */
.angel-layer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 89; /* è“‹åœ¨å­—å¹•å¡ä¸Šã€ä½æ–¼ç…™ç« */
}

/* åœ¨æ•´å€‹å­—å¹•å¡å€ç”±ä¸Šå¾€ä¸‹é£„è½çš„ angel-wing */
.angel-feather{
  position:absolute;

  /* ğŸ”¹ å°ºå¯¸æ”¹ç”¨è®Šæ•¸æ§åˆ¶ï¼Œé è¨­æ¯”ä»¥å‰å°ä¸€é» */
  width: var(--size, 80px);
  height: var(--size, 80px);

  opacity:0;
  background-image:url("effects/angel-wing.png");
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;

  /* åŸºç¤å…‰æšˆæ¯”ä»¥å‰æŸ”ä¸€é»ï¼Œè®“å±¤æ¬¡æ„Ÿæ¯”è¼ƒæ¸…æ¥š */
  filter:
    drop-shadow(0 0 6px rgba(255,255,255,.9))
    drop-shadow(0 0 18px rgba(78,161,255,.75));

  /* JS åŸæœ¬å¡çš„ --dur é‚„æ˜¯æœƒç”Ÿæ•ˆ */
  animation: angelFeatherFallLeft var(--dur, 1900ms) ease-out forwards;
}

/* è¿‘æ™¯ç¾½æ¯›ï¼šæ¯”è¼ƒå¤§ã€æ¯”è¼ƒäº®ã€é£„çš„è·é›¢ç¨å¾®é•·ä¸€é» */
.angel-feather.near{
  --size: 96px;  /* å¤§é¡†ä¸€é» */
  filter:
    drop-shadow(0 0 10px rgba(255,255,255,1))
    drop-shadow(0 0 28px rgba(78,161,255,.95));
}

/* é æ™¯ç¾½æ¯›ï¼šæ¯”è¼ƒå°ã€æ¯”è¼ƒæ·¡ï¼Œç•¶ä½œèƒŒæ™¯å±¤æ¬¡ */
.angel-feather.far{
  --size: 62px;  /* å°é¡†ä¸€é» */
  filter:
    drop-shadow(0 0 4px rgba(255,255,255,.75))
    drop-shadow(0 0 14px rgba(78,161,255,.6));
}

/* åå‘é£„å‹•ï¼ˆå‘å¦ä¸€é‚Šæ™ƒï¼‰ */
.angel-feather.right{
  animation-name: angelFeatherFallRight;
}

/* å·¦å³ç¿»è½‰ï¼šåœ–ç‰‡æœ¬èº«é¡åƒï¼Œè·¯å¾‘ä»ç”± keyframes æ§åˆ¶ */
.angel-feather.flip{
  transform: scaleX(-1);
}

/* å¾€å·¦å†å¾€å³çš„è·¯å¾‘ï¼šç¯„åœæ¯”ä»¥å‰æ›´å¯¬ï¼Œç¾½æ¯›çœ‹èµ·ä¾†æ¯”è¼ƒåˆ†æ•£ */
@keyframes angelFeatherFallLeft{
  5%{
    opacity:0;
    transform:
      translate(-50%, -40px)           /* èµ·é»ç•¥åœ¨ä¸Šæ–¹ */
      translateX(0)
      scale(var(--scale, .85))
      rotate(var(--rotStart, -10deg));
  }
  20%{
    opacity:1;
  }
  55%{
    transform:
      translate(-50%, 130px)           /* ä¸­æ®µï¼šåœ¨å­—å¹•å¡ä¸­é–“é™„è¿‘ */
      translateX(-32px)                /* å¾€å·¦åå¤šä¸€é»ï¼Œæ‹‰é–‹è·é›¢ */
      scale(calc(var(--scale, 1) * 0.95))
      rotate(0deg);
  }
  100%{
    opacity:0;
    transform:
      translate(-50%, 260px)           /* çµå°¾ï¼šæ¯”åŸæœ¬å†ä½ä¸€äº› */
      translateX(40px)                 /* å†å¾€å³ä¸€é»ï¼Œç•«å‡ºå¤§ S å½ */
      scale(calc(var(--scale, 1) * 1.05))
      rotate(var(--rotEnd, 10deg));
  }
}

/* å¾€å³å†å¾€å·¦çš„è·¯å¾‘ï¼ˆåæ–¹å‘ï¼‰ */
@keyframes angelFeatherFallRight{
  5%{
    opacity:0;
    transform:
      translate(-50%, -40px)
      translateX(0)
      scale(var(--scale, .85))
      rotate(var(--rotStart, 10deg));
  }
  20%{
    opacity:1;
  }
  55%{
    transform:
      translate(-50%, 130px)
      translateX(32px)                 /* é€™é‚Šåå‘å¾€å³ */
      scale(calc(var(--scale, 1) * 0.95))
      rotate(0deg);
  }
  100%{
    opacity:0;
    transform:
      translate(-50%, 260px)
      translateX(-40px)
      scale(calc(var(--scale, 1) * 1.05))
      rotate(var(--rotEnd, -10deg));
  }
}

/* å¾é¸æ‰‹é ­åƒä¸­å¿ƒå¾€å¤–å™´å‡ºçš„æ„›å¿ƒï¼ˆé€™æ®µç¶­æŒåŸä¾†è¨­å®šå³å¯ï¼‰ */
.angel-bubble{
  position:absolute;
  width:40px;
  height:40px;
  opacity:0;
  background-image:url("effects/heart.png");
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
  animation: angelBubbleBurst 900ms ease-out forwards;
}

@keyframes angelBubbleBurst{
  0%{
    opacity:0;
    transform: translate(0, 0) scale(.4);
  }
  20%{
    opacity:1;
    transform: translate(0, 0) scale(1.0);
  }
  60%{
    opacity:1;
    transform: translate(
      calc(var(--dx) * 0.7),
      calc(var(--dy) * 0.7)
    ) scale(1.05);
  }
  100%{
    opacity:0;
    transform: translate(var(--dx), var(--dy)) scale(.9);
  }
}
/* âœ… æ‰‹æ©Ÿç‰ˆï¼šå­—å¹•å¡ï¼ˆoverlayï¼‰æ”¹æˆä¸Šä¸‹æ’ï¼Œé¿å…å³å´è¢«æ“ æˆç›´æ’ */
@media (max-width: 768px){

  /* overlay ç”±å·¦å³ä¸¦æ’ â†’ ä¸Šä¸‹ */
  .overlay{
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  /* å·¦å´æŠ½å¡å€ç½®ä¸­ */
  .overlay-left{
    flex: 0 0 auto;
    width: 100%;
    justify-content: center;
  }

  /* å³å´æ–‡å­—å€æ’æ»¿ã€ç½®ä¸­ */
  .overlay-right{
    width: 100%;
    text-align: center;
  }

  /* æ¨™é¡Œé‚£è¡Œï¼šä¸è¦è¢«æ‹†å­— */
  .overlay-title{
    white-space: nowrap;
    font-size: 40px;   /* æƒ³æ›´å°å°± 34~38 */
    line-height: 1.1;
  }

  /* æ¨™é¡Œåˆ—æ”¹æˆç½®ä¸­æ’ç‰ˆ */
  .overlay-title-row{
    justify-content: center;
    flex-wrap: wrap;
  }

  /* é¸æ‰‹é ­åƒç¾¤ï¼šç½®ä¸­ã€å¯æ›è¡Œï¼Œä¸è¦è®Šæˆä¸€æ¢ç›´ç·š */
  .overlay-players{
    justify-content: center;
  }
}
/* âœ… åªå½±éŸ¿é›»è…¦ç‰ˆï¼šè®“æ•´å€‹ç‰ˆé¢ç½®ä¸­ */
@media (min-width: 1101px){
  .app{
    max-width: 1400px;   /* ä½ æƒ³è¦çš„é›»è…¦ç‰ˆå¯¬åº¦ï¼šå¯æ”¹ 1360 / 1440 / 1520 */
    margin: 18px auto;   /* ç½®ä¸­ */
  }
}

  </style>
</head>

<body>
<div class="viewport">
    <div id="stage">
  <!-- é–‹å ´èªªæ˜ -->
  <div id="splash">
    <div class="splash-card" role="dialog" aria-modal="true">
      <div class="splash-left">
        <h3 class="splash-title">QCCå¤§å¯Œç¿æŒ‘æˆ°è³½ å®Œæ•´è³½æ³ï¼ˆåå›åˆï¼‰</h3>
        <div class="splash-lines">
          <div>â€¢ é€™æ˜¯ç«¶è³½å›æ”¾å‹•ç•«ï¼šæ¯ä½é¸æ‰‹ä»¥å‹•ç‰©é ­åƒä»£è¡¨ï¼Œç©åˆ†ï¼å‰é€²æ­¥æ•¸ï¼Œç¬¬ä¸€å€‹åˆ°é”çµ‚é»æ˜¯å† è»ã€‚</div>
          <div>â€¢ ä¸Šæ–¹å­—å¹•æœƒé¡¯ç¤ºã€Œå›åˆï¼æ—¥æœŸï¼é …ç›®ï¼å¾—åˆ†èªªæ˜ã€ã€‚</div>
          <div>â€¢ ä¸‹æ–¹è³½é“æœƒé¡¯ç¤ºå„é¸æ‰‹ç›®å‰å‰é€²çš„æ ¼æ•¸ï¼Œå¡ç‰Œå€æœƒåœ¨å€‹åˆ¥æŠ½å¡æ™‚ç¿»ç‰Œã€‚</div>
          <div style="margin-top:8px;">é»ã€Œé–‹å§‹æ’­æ”¾ã€å³å¯è‡ªå‹•æ’­æ”¾ï¼Œæˆ–é—œé–‰å¾Œç”¨ä¸Šæ–¹ã€Œä¸‹ä¸€æ­¥ã€æ…¢æ…¢çœ‹ã€‚</div>
        </div>
      </div>
      <div class="splash-right">
        <img src="" alt="" style="width:80px;height:80px;opacity:.0" />
        <button id="splashStart">é–‹å§‹æ’­æ”¾</button>
        <button id="splashLater"
                style="background:linear-gradient(180deg,#fff8e1,#fff3c4); border:1px solid rgba(255,180,3,.14);">
          ç¨å¾Œï¼ˆå¯æ‰‹å‹•ï¼‰
        </button>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="topbar">
      <div class="controls">
        <button id="btnStart">é–‹å§‹æ’­æ”¾</button>
        <button id="btnPrev">ä¸Šä¸€æ­¥</button>
        <button id="btnNext">ä¸‹ä¸€æ­¥</button>
        <button id="btnReset">é‡ç½®</button>
        <label class="speed">
          é€Ÿåº¦
          <input id="speed" type="range" min="0.6" max="2.0" value="1.0" step="0.1" />
          <span id="speedText">1.0x</span>
        </label>
      </div>
            <div style="color:var(--muted); font-size:13px;">
        å·¦å´ï¼šå›åˆè·³è½‰ï¼‹é€šé—œæ’åï¼›ä¸­é–“ï¼šå­—å¹•å¡ï¼‹è³½é“ï¼›å³å´ï¼šå³æ™‚åæ¬¡ã€‚
      </div>

    </div>

        <main class="layout">
      <!-- å·¦å´ï¼šå›åˆå¿«é€Ÿè·³è½‰ + é€šé—œæ’å -->
      <aside class="side-left">
        <div class="round-jump">
          <div class="round-jump-label">å¿«é€Ÿè·³åˆ°å›åˆ</div>
          <div class="round-jump-buttons" id="roundJumpButtons"></div>
        </div>

        <!-- ğŸ”¹ é€šé—œæ’åï¼šç¬¬ä¸€å€‹æœ‰äººåˆ°çµ‚é»æ‰æœƒé¡¯ç¤º -->
        <div id="clearRankSection" class="clear-section rank-section" hidden>
          <h2>é€šé—œæ’å</h2>
          <div class="rank-note">ä¾ã€ŒæŠµé”çµ‚é»çš„é †åºã€æ’åºã€‚</div>
          <ol class="rank" id="clearRank"></ol>
        </div>
      </aside>

      <!-- ä¸­é–“ï¼šå­—å¹•å¡ + è³½é“ -->
      <section class="stage">
        <!-- å­—å¹•å¡ï¼šå¡ç‰Œåœ¨å·¦ï¼Œæ–‡å­—åœ¨å³ -->
        <div class="overlay" id="overlay" aria-live="polite">
          <!-- ç¬¬ä¸€åæ©«å¹… -->
          <div id="winnerBanner" class="winner-banner"></div>

          <div class="overlay-left">
            <div class="card-area" id="cardArea">
              <!-- ğŸŒ¸ æ«»èŠ±é£„è½å°ˆç”¨å±¤ -->
              <div class="overlay-petal-layer" id="overlayPetals"></div>
              <div class="card" id="card">
                <div class="card-face card-back">CARD</div>
                <div class="card-face card-front" id="cardFront">+4</div>
              </div>

              <div class="card-hint" id="cardHint">æŠ½å¡çµæœ</div>
            </div>
          </div>

          <div class="overlay-right">
            <div class="overlay-title-row">
              <div class="overlay-title" id="overlayTitle">æº–å‚™é–‹å§‹</div>
              <div class="overlay-badge hidden" id="overlayBadge"></div>
            </div>
            <div class="overlay-lines" id="overlayLines"></div>
            <div class="overlay-players" id="overlayPlayers" hidden></div>
            <div class="overlay-note" id="overlayNote"></div>
          </div>
        </div>

        <!-- è·‘é“å€ -->
        <div class="lanes-wrap">
          <div class="lanes-header">æ¯æ¢è³½é“ä»£è¡¨ä¸€ä½é¸æ‰‹ï¼Œå³å´çµ‚é»ç‚ºç¬¬ 46 æ ¼ã€‚</div>
          <div id="lanes"></div>
        </div>
      </section>

      <!-- å³å´ï¼šå³æ™‚åæ¬¡ -->
      <aside class="sidebar">
        <!-- ğŸ”¹ å³æ™‚æ’å -->
        <div class="rank-section">
          <h2>å³æ™‚æ’å</h2>
          <div class="rank-note">ä¾ã€Œç›®å‰æ‰€åœ¨æ ¼ã€æ’åºï¼ˆåŒæ ¼ä¾åå–®é †åºï¼‰ã€‚</div>
          <ol class="rank" id="rank"></ol>
        </div>
      </aside>
    </main>

  </div>

  <!-- ç…™ç«ç‰¹æ•ˆï¼ˆç¬¬ä¸€åï¼‰ -->
  <div id="fireworks"></div>

  <!-- é“å…·ç‰¹æ•ˆ -->
  <div id="itemFx"></div>

  <!-- å¸¸é§ BGM -->
<audio id="bgm-normal"  src="music/normal.mp3"  preload="auto" loop></audio>

<!-- é­”æ³•ç‰¹æ•ˆç”¨ -->
<audio id="bgm-magic"   src="music/magic.mp3"   preload="auto"></audio>

<!-- ç·Šå¼µ BGMï¼ˆ38 æ ¼ä¹‹å¾Œï¼‰ -->
<audio id="bgm-nervous" src="music/nervous.mp3" preload="auto" loop></audio>

<!--æ…¶ç¥ BGM(ç¬¬ä¸€ä½é¸æ‰‹ç”¢ç”Ÿæ™‚æ’­åˆ°ç…™ç«çµæŸ) -->
<audio id="bgm-celebrate" src="music/celebrate.mp3" preload="auto" loop></audio>

<!-- çµ‚é» BGMï¼ˆ46 æ ¼å¾Œåˆ°æ’­æ”¾çµæŸï¼‰ -->
<audio id="bgm-finish"  src="music/finish.mp3"  preload="auto" loop></audio>


  <script>
    // ====== åŸºæœ¬è¨­å®š ======
    const TRACK_CELLS = 90;  // è³½é“é‚è¼¯ä¸Šæœ€å¤§æ ¼æ•¸ï¼ˆé¡¯ç¤ºç”¨ï¼‰
    const FINISH = 46;       // å† è»çµ‚é»

    const players = [
      { id:"crane",     name:"ä¸¹é ‚é¶´", img:"animals/crane.png" },
      { id:"monkey",    name:"å°çŒ´",   img:"animals/monkey.png" },
      { id:"parrot",    name:"é¸šéµ¡",   img:"animals/parrot.png" },
      { id:"meerkat",   name:"ç‹ç´",   img:"animals/meerkat.png" },
      { id:"porcupine", name:"è±ªè±¬",   img:"animals/porcupine.png" },
      { id:"capybara",  name:"æ°´è±š",   img:"animals/capybara.png" },
      { id:"ape",       name:"äººçŒ¿",   img:"animals/ape.png" },
      { id:"seal",      name:"æµ·è±¹",   img:"animals/seal.png" },
      { id:"crocodile", name:"é±·é­š",   img:"animals/crocodile.png" },
      { id:"moose",     name:"éº‹é¹¿",   img:"animals/moose.png" },
      { id:"camel",     name:"é§±é§",   img:"animals/camel.png" },
      { id:"raccoon",   name:"æµ£ç†Š",   img:"animals/raccoon.png" },
      { id:"bear",      name:"å°ç†Š",   img:"animals/bear.png" },
      { id:"sloth",     name:"æ¨¹æ‡¶",   img:"animals/sloth.png" },
      { id:"pigeon",    name:"é´¿å­",   img:"animals/pigeon.png" },
      { id:"baboon",    name:"ç‹’ç‹’",   img:"animals/baboon.png" },
      { id:"otter",     name:"æ°´çº",   img:"animals/otter.png" },
      { id:"tiger",     name:"è€è™",   img:"animals/tiger.png" },
      { id:"peacock",   name:"å­”é›€",   img:"animals/peacock.png" },
    ];

    // === å›åˆè³‡æ–™ï¼ˆ1~10 å›åˆï¼‰ ===
    const rounds = [
      {
        round: 1, title: "æ—¥å¸¸ç©åˆ†",
        groupEvents: [
          { date: "10/7",  item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
          { date: "10/10", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: []
      },
      {
        round: 2, title: "æ—¥å¸¸ç©åˆ†",
        groupEvents: [
          { date: "10/13", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "allExcept", except: ["pigeon"], points: 1, note: "é´¿å­åœç•™ +0ï¼Œå…¶é¤˜ +1" },
          { date: "10/17", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: []
      },
      {
        round: 3, title: "ä¸å®šæœŸç©åˆ†",
        groupEvents: [
          { date: "10/23", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "allExcept", except: ["moose"], points: 1, note: "éº‹é¹¿åœç•™ +0ï¼Œå…¶é¤˜ +1" },
          { date: "10/24", item: "äº¤å‰å·¡æª¢æ”¹å–„å–®", type: "only", only: ["porcupine","capybara","ape","seal","crocodile","moose","camel"], points: 2, note: "3æ—¥å…§å›è¦† +2" },
          { date: "10/24", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: []
      },
      {
        round: 4, title: "ä¸å®šæœŸç©åˆ†",
        groupEvents: [
          { date: "10/28", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
          { date: "10/29", item: "äº¤å‰å·¡æª¢æ”¹å–„å–®", type: "only", only: ["raccoon","bear","sloth","pigeon","baboon","otter","tiger","peacock"], points: 1, note: "4-7æ—¥å…§å›è¦† +1" },
          { date: "10/31", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: []
      },
      {
        round: 5, title: "æ—¥å¸¸ç©åˆ†",
        groupEvents: [
          { date: "11/4", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "allExcept", except: ["crocodile"], points: 1, note: "é±·é­šåœç•™ +0ï¼Œå…¶é¤˜ +1" },
          { date: "11/7", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: []
      },
      {
        round: 6, title: "é¡å¤–ç©åˆ†",
        groupEvents: [
          {
            date: "11/13",
            item: "éæ•åŸæ¸¬é©—é”æ¨™ç",
            type: "byMap",
            by: { crane: 2, monkey: 4, parrot: 1, porcupine: 1, capybara: 2, ape: 4, seal: 3, camel: 4, raccoon: 2, pigeon: 4 },
            note: "é”æ¨™é¸æ‰‹ä¾æˆç¸¾ç²å¾—ä¸åŒæ­¥æ•¸"
          },
          { date: "11/13", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
          { date: "11/14", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: [
          { date: "11/13", who: "camel",     reason: "MP2503 å¯©æŸ¥é€šé", card: 0, camelBonus: true },
          { date: "11/13", who: "capybara",  reason: "MP2504 å¯©æŸ¥é€šé", card: 4 },
          { date: "11/13", who: "porcupine", reason: "MP2505 å¯©æŸ¥é€šé", card: 6 },
        ]
      },
      {
        round: 7, title: "æ—¥å¸¸ç©åˆ†",
        groupEvents: [
          { date: "11/17", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "allExcept", except: ["seal"], points: 1, note: "æµ·è±¹é™¤å¤–ï¼Œå…¶é¤˜ +1" },
          { date: "11/19", item: "ç‰¹æ®Šæ ¼çå‹µ", type: "only", only: ["crane","parrot","crocodile","moose","bear","sloth","baboon","otter","tiger","peacock"], points: 1, note: "æŠµé”ç¬¬13æ ¼ +1",fx: "angel" },
          { date: "11/21", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: [
          { date: "11/17", who: "crane",   reason: "MP2507 å¯©æŸ¥é€šé", card: 6 },
          { date: "11/18", who: "peacock", reason: "MP2508 å¯©æŸ¥é€šé", card: 1 },
        ]
      },
      {
        round: 8, title: "ä¸å®šæœŸç©åˆ†",
        groupEvents: [
          { date: "11/25", item: "äº¤å‰å·¡æª¢æ”¹å–„å–®", type: "allExcept", except: ["meerkat"], points: 2, note: "3æ—¥å…§å›è¦† +2ï¼ˆç‹ç´é™¤å¤–ï¼‰" },
          { date: "11/25", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "allExcept", except: ["otter"], points: 1, note: "æ°´çºåœç•™ +0ï¼Œå…¶é¤˜ +1" },
          { date: "11/28", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
        ],
        soloEvents: [
          { date: "11/24", who: "ape",     reason: "MP2510 å¯©æŸ¥é€šé", card: 3 },
          { date: "11/28", who: "meerkat", reason: "äº¤å‰å·¡æª¢æ”¹å–„å–®4-7æ—¥å…§å›è¦†", card: 1 },
        ]
      },

        {
  round: 9,
  title: "é¡å¤–ç©åˆ†",
  groupEvents: [
    {
      date: "12/2",
      item: "GHPæ¸¬é©—é”æ¨™çå‹µ",
      type: "byMap",
      by: {
        crane: 10, monkey: 10, parrot: 2, porcupine: 11, capybara: 10,
        ape: 9, seal: 3, moose: 5, camel: 10, raccoon: 3,
        sloth: 2, pigeon: 5, baboon: 4, otter: 6, peacock: 10
      },
      note: "é”æ¨™é¸æ‰‹ä¾æˆç¸¾ç²å¾—ä¸åŒæ­¥æ•¸"
    },
    {
      date: "12/3",
      item: "ç‰¹æ®Šæ ¼çå‹µ",
      type: "only",
      only: ["peacock"],
      points: 1,
      note: "æŠµé”31æ ¼ +1",
      fx: "angel"
    },
    { date: "12/5", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
    { date: "12/5", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
    { date: "12/8", item: "æ¯é€±ä»»å‹™åˆ†æ•¸åŠ å€", type: "allExcept", except: ["peacock"], points: 2, note: "å­”é›€åœç•™ +0ï¼Œå…¶é¤˜ +2" },
    {
      date: "12/10",
      item: "è‡ªä¸»ææ¡ˆäººçå‹µ",
      type: "byMap",
      by: { crane: 10, monkey: 12, parrot: 1, porcupine: 9, capybara: 1, ape: 23, seal: 1, camel: 6, raccoon: 1, peacock: 7 },
      note: "ææ¡ˆäººä¾çå‹µç²å¾—ä¸åŒæ­¥æ•¸"
    },
  ],

  soloEvents: [
    { date: "12/1", who: "crane",   reason: "MP2514 å¯©æŸ¥é€šé", card: 2 },
    { date: "12/1", who: "parrot",  reason: "MP2515 å¯©æŸ¥é€šé", card: 5 },

    { date: "12/3", who: "ape",       reason: "MP2516 å¯©æŸ¥é€šé", card: 3 },
    { date: "12/3", who: "ape",       reason: "MP2517 å¯©æŸ¥é€šé", card: 5 },
    { date: "12/3", who: "porcupine", reason: "MP2518 å¯©æŸ¥é€šé", card: 6 },
    { date: "12/3", who: "monkey",    reason: "MP2519 å¯©æŸ¥é€šé", card: 6 },

    { date: "12/4", who: "camel",     reason: "MP2503 å‰é€²å¡ï¼ˆä½¿ç”¨ï¼‰", card: 4, camelUse: true },
    { date: "12/4", who: "monkey",    reason: "MP2520 å¯©æŸ¥é€šé", card: 3 },
    { date: "12/4", who: "monkey",    reason: "MP2521 å¯©æŸ¥é€šé", card: 4 },
    { date: "12/4", who: "ape",       reason: "MP2522 å¯©æŸ¥é€šé", card: 2 },
    { date: "12/4", who: "monkey",    reason: "MP2524 å¯©æŸ¥é€šé", card: 2 },

    { date: "12/5", who: "ape",       reason: "MP2527 å¯©æŸ¥é€šé", card: 4 },
    { date: "12/5", who: "porcupine", reason: "MP2528 å¯©æŸ¥é€šé", card: 5 },
    { date: "12/5", who: "ape",       reason: "MP2529 å¯©æŸ¥é€šé", card: 2 },
    { date: "12/5", who: "crane",     reason: "MP2530 å¯©æŸ¥é€šé", card: 2 },
  ]
},

{
  round: 10,
  title: "æ—¥å¸¸ï¼‹é¡å¤–ç©åˆ†",
  groupEvents: [
    // æ—¥å¸¸
    { date: "12/12", item: "æ‰‹éƒ¨å¡—æŠ¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
    { date: "12/12", item: "æœè£å„€å®¹æª¢æŸ¥", type: "all", points: 1, note: "å…¨é«”é€šé +1" },
    { date: "12/15", item: "æ¯é€±ä»»å‹™åˆ†æ•¸åŠ å€", type: "all", points: 2, note: "å…¨é«”é€šé +2" },

    // é¡å¤–
    {
      date: "12/10",
      item: "ç‰¹æ®Šæ ¼çå‹µ",
      type: "only",
      only: ["pigeon"],
      points: 1,
      note: "æŠµé”31æ ¼ +1",
      fx: "angel"
    },
    {
      date: "12/16",
      item: "è‡ªä¸»ææ¡ˆäººçå‹µ",
      type: "byMap",
      by: { monkey: 2, camel: 4, pigeon: 9 },
      note: "ææ¡ˆäººä¾çå‹µç²å¾—ä¸åŒæ­¥æ•¸"
    },
    { date: "12/16", item: "ä¸»è¾¦å–®ä½çå‹µ", type: "all", points: 5, note: "æ„Ÿè¬å¤§å®¶ç©æ¥µåƒèˆ‡!" },
  ],

  soloEvents: [
    { date: "12/11", who: "monkey",  reason: "MP2535 å¯©æŸ¥é€šé", card: 2 },
    { date: "12/12", who: "pigeon",  reason: "MP2538 å¯©æŸ¥é€šé", card: 6 },
    { date: "12/12", who: "pigeon",  reason: "MP2541 å¯©æŸ¥é€šé", card: 2 },
  ]
}

    ];

// ====== éŸ³æ•ˆæ§åˆ¶ ======
const audioNormal  = document.getElementById("bgm-normal");
const audioMagic   = document.getElementById("bgm-magic");
const audioNervous = document.getElementById("bgm-nervous");
const audioCelebrate = document.getElementById("bgm-celebrate");
const audioFinish  = document.getElementById("bgm-finish");

// â˜… çµ±ä¸€ç®¡ç†éŸ³é‡ï¼ˆå¯ä»¥ä¹‹å¾Œè‡ªå·±å¾®èª¿æ•¸å­—ï¼‰
const BGM_VOLUME_BASE   = 0.7;  // BGM åŸæœ¬éŸ³é‡ï¼ˆnormal / nervous / finishï¼‰
const BGM_VOLUME_DIMMED = 0.45; // æ’­é­”æ³•éŸ³æ•ˆæ™‚ï¼ŒBGM ç¨å¾®å£“ä½
const MAGIC_VOLUME      = 1.0;  // é­”æ³•éŸ³æ•ˆéŸ³é‡

// åˆå§‹åŒ–éŸ³é‡
if (audioNormal)  audioNormal.volume  = BGM_VOLUME_BASE;
if (audioNervous) audioNervous.volume = BGM_VOLUME_BASE;
if (audioFinish)  audioFinish.volume  = BGM_VOLUME_BASE;
if (audioMagic)   audioMagic.volume   = MAGIC_VOLUME;
if (audioCelebrate) audioCelebrate.volume = BGM_VOLUME_BASE;

// ç›®å‰çš„ä¸» BGMï¼š "normal" | "nervous" | "finish" | null
let currentMainBgm = null;
// æ˜¯å¦æ­£åœ¨æ’­æ”¾é­”æ³•éŸ³æ•ˆ
let magicPlaying   = false;

// â­ é€™å…©å€‹æ˜¯ã€Œ38 æ ¼ç·Šå¼µ BGMã€è·Ÿã€Œ46 æ ¼çµ‚é» BGMã€æœ‰æ²’æœ‰å•Ÿå‹•é
let nervousStarted = false;
let finishStarted  = false;
// ====== 38~46 ç«¶é€Ÿæ•ˆæœæ§åˆ¶ ======
let rivalryStarted = false; // ç¬¬ä¸€æ¬¡æœ‰äººåˆ° 38 æ‰æœƒè®Š trueï¼ˆåªå•Ÿå‹•ä¸€æ¬¡ï¼‰
let rivalryEnded   = false; // ç¬¬ä¸€å€‹åˆ° 46 å¾Œè®Š trueï¼ˆæ°¸é ä¸å†å•Ÿå‹•ï¼‰


let nervousAt = null;  // ç¬¬ä¸€æ¬¡é€²å…¥ 38 æ ¼ä»¥ä¸Šçš„æ™‚é–“
let finishAt  = null;  // ç¬¬ä¸€æ¬¡é€²å…¥ 46 æ ¼ä»¥ä¸Šçš„æ™‚é–“

// å°å·¥å…·ï¼šæš«åœä¸¦æ­¸é›¶æŒ‡å®šçš„ audio
function stopAudio(a){
  if (!a) return;
  a.pause();
  try { a.currentTime = 0; } catch(e){}
}

// åœæ‰æ‰€æœ‰ä¸» BGM
function stopAllMainBgm(){
  stopAudio(audioNormal);
  stopAudio(audioNervous);
  stopAudio(audioFinish);
}

// æ’­æ”¾ä¸» BGMï¼ˆæœƒè¨˜éŒ„ç›®å‰æ˜¯å“ªç¨®ï¼‰
// kind: "normal" | "nervous" | "finish" | null
async function playMainBgm(kind){
  currentMainBgm = kind;

  // ä¸å†å› ç‚ºé­”æ³•éŸ³æ•ˆè€Œç¦æ­¢åˆ‡æ› BGM
  stopAllMainBgm();

  let target = null;
  if (kind === "normal")  target = audioNormal;
  if (kind === "nervous") target = audioNervous;
  if (kind === "finish")  target = audioFinish;

  if (target){
    // ç¢ºä¿ BGM ç”¨çš„æ˜¯ã€ŒåŸæœ¬åŸºæº–éŸ³é‡ã€
    target.volume = magicPlaying ? BGM_VOLUME_DIMMED : BGM_VOLUME_BASE;


    try {
      await target.play();
    } catch(e){
      console.warn("BGM play error:", e);
    }
  }
}


function playMagicOnce(){
  // fastMode æˆ–æ²’æœ‰éŸ³æª”æ™‚ï¼Œç›´æ¥ç•¶ä½œã€Œå·²å®Œæˆã€
  if (fastMode || !audioMagic) return Promise.resolve();

  magicPlaying = true;

  // æ’­é­”æ³•éŸ³æ•ˆå‰ï¼ŒæŠŠä¸‰ç¨® BGM ç¨å¾®å£“ä½ä¸€é»éŸ³é‡
  if (audioNormal)  audioNormal.volume  = BGM_VOLUME_DIMMED;
  if (audioNervous) audioNervous.volume = BGM_VOLUME_DIMMED;
  if (audioFinish)  audioFinish.volume  = BGM_VOLUME_DIMMED;

  // å¾é ­æ’­ä¸€æ¬¡é­”æ³•éŸ³æ•ˆ
  stopAudio(audioMagic);
  audioMagic.volume = MAGIC_VOLUME;

  return new Promise(resolve => {
    let done   = false;
    const MAX_MS = 3000;   // â­ æœ€å¤šæ’­æ”¾ 3 ç§’
    let timer  = null;

    function finish(){
      if (done) return;
      done = true;

      // æ¸…æ‰ 3 ç§’è¨ˆæ™‚å™¨
      if (timer !== null){
        clearTimeout(timer);
        timer = null;
      }

      // â­ å¼·åˆ¶åœæ­¢é­”æ³•éŸ³æ•ˆ
      stopAudio(audioMagic);
      audioMagic.onended = null;

      magicPlaying = false;

      // é­”æ³•éŸ³æ•ˆçµæŸå¾Œï¼ŒæŠŠ BGM éŸ³é‡æ‹‰å›åŸæœ¬åŸºæº–å€¼
      if (audioNormal)  audioNormal.volume  = BGM_VOLUME_BASE;
      if (audioNervous) audioNervous.volume = BGM_VOLUME_BASE;
      if (audioFinish)  audioFinish.volume  = BGM_VOLUME_BASE;

      resolve();
    }

    // â­ ä¸ç®¡éŸ³æª”æœ‰å¤šé•·ï¼Œæœ€å¤š 3 ç§’å°±å¼·åˆ¶çµæŸ
    timer = setTimeout(() => {
      // console.log("magic bgm force stop after 3s");
      finish();
    }, MAX_MS);

    audioMagic.play().catch(e=>{
      console.warn("magic play error:", e);
      finish();   // æ’­ä¸å‡ºä¾†ä¹Ÿç•¶ä½œçµæŸ
    });

    // å¦‚æœéŸ³æ•ˆæœ¬èº«åœ¨ 3 ç§’å…§å°±æ’­å®Œï¼Œä¹Ÿæœƒèµ°é€™è£¡
    audioMagic.onended = () => {
      finish();
    };
  });
}

// ====== celebrateï¼šä¸åŠ é€Ÿï¼Œåªæ’­ 0~7 ç§’ ======
function playCelebrate7sOnce(){
  if (fastMode || !audioCelebrate) return Promise.resolve();

  const FROM_SEC = 0;
  const TO_SEC   = 7;
  const PLAY_MS  = 7000;

  // åœæ‰ä¸Šä¸€æ®µ celebrateï¼Œé¿å…ç–ŠéŸ³
  stopAudio(audioCelebrate);

  // ç¢ºä¿æ­£å¸¸é€Ÿåº¦
  audioCelebrate.playbackRate = 1;
  audioCelebrate.currentTime  = FROM_SEC;

  return new Promise(resolve => {
    let done  = false;
    let timer = null;

    function finish(){
      if (done) return;
      done = true;

      if (timer) clearTimeout(timer);

      stopAudio(audioCelebrate);
      audioCelebrate.ontimeupdate = null;
      audioCelebrate.onended = null;
      resolve();
    }

    // ä¸ƒç§’åˆ°å°±åˆ‡
    timer = setTimeout(finish, PLAY_MS);

    audioCelebrate.play().catch(e => {
      console.warn("celebrate play error:", e);
      finish();
    });

    // ä¿éšªï¼šå¦‚æœæ’­æ”¾æ™‚é–“è·‘åˆ° 7 ç§’ä¹Ÿåˆ‡
    audioCelebrate.ontimeupdate = () => {
      if (audioCelebrate.currentTime >= TO_SEC) finish();
    };

    audioCelebrate.onended = () => finish();
  });
}

// ä¾›é‡è¨­æ™‚ä½¿ç”¨
function resetBgm(){
  magicPlaying   = false;
  currentMainBgm = null;
  stopAudio(audioMagic);
  stopAudio(audioCelebrate);
  if (audioNervous) audioNervous.playbackRate = 1; // âœ… é‚„åŸ
  if (audioFinish)  audioFinish.playbackRate  = 1;
  if (audioNormal)  audioNormal.playbackRate  = 1;
  stopAllMainBgm();
}

    // ====== ç‹€æ…‹ & DOM ======
    const state = {
  pos: Object.fromEntries(players.map(p => [p.id, 0])),
  speed: 1.0,
  finished: null,       // ç¬¬ä¸€å€‹é€šé—œè€…ï¼ˆå† è»ï¼‰
  finishOrder: [],      // ä¾æŠµé”çµ‚é»çš„é †åºå­˜æ”¾ id
  stepQueue: [],
  roundStartStep: {},
};


    let fastMode = false;

    const rankCache = new Map();     // id -> li
let prevRankIndex = new Map();   // id -> ä¸Šä¸€æ¬¡åæ¬¡(0-based)
let winnerStarInterval = null;   // å† è»è³½é“å™´æ˜Ÿæ˜Ÿçš„å®šæ™‚å™¨




    const btnStart = document.getElementById("btnStart");
    const btnPrev  = document.getElementById("btnPrev");
    const btnNext  = document.getElementById("btnNext");
    const btnReset = document.getElementById("btnReset");
    const speedEl  = document.getElementById("speed");
    const speedTextEl = document.getElementById("speedText");

    const splash      = document.getElementById("splash");
    const splashStart = document.getElementById("splashStart");
    const splashLater = document.getElementById("splashLater");

    const fireworksEl = document.getElementById("fireworks");
    const itemFxEl   = document.getElementById("itemFx");
    const roundJumpButtonsEl = document.getElementById("roundJumpButtons");
    const winnerBannerEl = document.getElementById("winnerBanner");
    const clearRankSectionEl = document.getElementById("clearRankSection");
    const clearRankListEl    = document.getElementById("clearRank");

    function sleep(ms){
  const factor = 1.15;  // å…¨éƒ¨ç¯€å¥æ”¾æ…¢ 1.15 å€ï¼ˆæƒ³å†æ…¢ä¸€é»å°± 1.2ï¼‰
  return new Promise(r => setTimeout(r, fastMode ? 0 : ms * factor));
}
    function findPlayer(id){ return players.find(p => p.id === id); }
    function findName(id){ return findPlayer(id)?.name ?? id; }

    const stageEl = document.querySelector(".stage");
    const lanesEl = document.getElementById("lanes");
    const rankEl  = document.getElementById("rank");

    const overlayTitleEl   = document.getElementById("overlayTitle");
    const overlayLinesEl   = document.getElementById("overlayLines");
    const overlayPlayersEl = document.getElementById("overlayPlayers");
    const overlayNoteEl    = document.getElementById("overlayNote");
    const overlayBadgeEl   = document.getElementById("overlayBadge");

    const cardAreaEl  = document.getElementById("cardArea");
    const cardEl      = document.getElementById("card");
    const cardFrontEl = document.getElementById("cardFront");
    const cardHintEl  = document.getElementById("cardHint");
    const overlayEl   = document.getElementById("overlay");
    // ====== æ•´é è‡ªå‹•ç¸®æ”¾ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ ======
const viewportEl = document.querySelector(".viewport");
const stageRootEl = document.getElementById("stage");

function fitStage(){
  // âœ… ä¸å†ç”¨ transform ç¸®æ”¾æ•´å€‹èˆå°ï¼ˆiOS æœƒè®“æ²å‹•/é«˜åº¦è¨ˆç®—æ€ªæ€ªçš„ï¼‰
  stageRootEl.style.transformOrigin = "top left";
  stageRootEl.style.transform = "none";
}

// è¦–çª—è®Šå‹•æ™‚é‡ç®—ï¼ˆresize / æ—‹è½‰ï¼‰
let fitTimer = null;
function requestFitStage(){
  clearTimeout(fitTimer);
  fitTimer = setTimeout(fitStage, 60);
}
window.addEventListener("resize", requestFitStage);
window.addEventListener("orientationchange", () => setTimeout(fitStage, 120));


// ğŸŒ¸ åœ¨å¡ç‰‡å€æ’­æ”¾ä¸€æ¬¡æ€§çš„æ«»èŠ±é›¨ï¼ˆå¾å³ä¸‹å¾€å·¦ä¸Šé£›ï¼‰
function playCardPetalsOnce(){
  if (fastMode) return Promise.resolve();

  // â˜… æ’­æ”¾ä¸€æ¬¡é­”æ³•éŸ³æ•ˆï¼Œæœƒå›å‚³ä¸€å€‹ Promise
  const magicPromise = playMagicOnce();

  const layer = document.getElementById("overlayPetals");
  if (!layer) return magicPromise;   // æ²’æœ‰åœ–å±¤å°±åªç­‰éŸ³æ•ˆçµæŸ

  // æ¸…ç©ºèˆŠçš„èŠ±ç“£
  layer.innerHTML = "";

  const PETAL_COUNT = 10;   // æƒ³æ›´å¯†å¯ä»¥èª¿å¤§
  let maxTime = 0;

  for (let i = 0; i < PETAL_COUNT; i++){
    const p = document.createElement("div");
    p.className = "overlay-petal";

    // å¤§å° 18~34px
    const size = 18 + Math.random() * 16;
    p.style.width  = size + "px";
    p.style.height = size + "px";

    // å¾å¡ç‰‡åå³ä¸‹è§’å‡ºç”Ÿ
    const startLeft = 55 + Math.random() * 40;  // 55% ~ 95%ï¼ˆåå³ï¼‰
    const startTop  = 55 + Math.random() * 35;  // 55% ~ 90%ï¼ˆåä¸‹ï¼‰
    p.style.left = startLeft + "%";
    p.style.top  = startTop  + "%";

    // é€Ÿåº¦ 2.4ï½3.2 ç§’
    const dur   = 2.4 + Math.random() * 0.8;
    const delay = Math.random() * 0.25;

    const r0    = (Math.random() * 360).toFixed(1) + "deg";
    const r1    = (Math.random() * 360).toFixed(1) + "deg";
    const alpha = 0.35 + Math.random() * 0.35;

    p.style.setProperty("--dur",   dur   + "s");
    p.style.setProperty("--delay", delay + "s");

    // è®“æ¯ç‰‡èŠ±ç“£çš„ä½ç§»ç¯„åœæ›´åˆ†æ•£ï¼ˆçµ¦ keyframes ç”¨ï¼‰
    p.style.setProperty("--dx", (60 + Math.random() * 180) + "px");
    p.style.setProperty("--dy", (80 + Math.random() * 220) + "px");

    p.style.setProperty("--r0",    r0);
    p.style.setProperty("--r1",    r1);
    p.style.setProperty("--alpha", alpha);

    // åŠ åˆ°åœ–å±¤è£¡
    layer.appendChild(p);

    // åœ¨ã€Œé€™ä¸€ç‰‡èŠ±ç“£ã€æ—é‚ŠåŠ  â™¥ / â­‘ å°ç«èŠ±ï¼ˆæœƒå¾€å¤–å™´å‡ºï¼‰
    attachPetalSparks(p, {min:1, max:3});

    // è¨˜ä¸€ä¸‹é€™ç‰‡å‹•ç•«ç¸½é•·ï¼Œç”¨ä¾†æ±ºå®šä½•æ™‚æ¸…ç©º
    maxTime = Math.max(maxTime, dur + delay);
  }

  // èŠ±ç“£çµæŸçš„ Promise
  const petalsPromise = new Promise(resolve => {
    const totalMs = (maxTime + 0.3) * 1000;
    setTimeout(() => {
      layer.innerHTML = "";
      resolve();
    }, totalMs);
  });

  // âœ… è®“å‘¼å«ç«¯å¯ä»¥ `await playCardPetalsOnce()`ï¼š
  //    æœƒåŒæ™‚ç­‰ã€Œé­”æ³•éŸ³æ•ˆã€ï¼‹ã€ŒèŠ±ç“£å‹•ç•«ã€éƒ½çµæŸ
  return Promise.all([magicPromise, petalsPromise]);
}


// åœ¨æŸå€‹èŠ±ç“£å…ƒç´ æ—é‚Šï¼Œéš¨æ©ŸåŠ å¹¾é¡† â™¥ / â­‘ å°ç™¼å…‰ï¼ˆç²‰ç´…è‰²ï¼Œå¾€å¤–å™´å‡ºï¼‰
function attachPetalSparks(el, {min = 1, max = 3} = {}){
  // è¦å¹¾é¡†å°å…‰é»
  const count = min + Math.floor(Math.random() * (max - min + 1));

  for (let i = 0; i < count; i++){
    const span = document.createElement("span");
    span.className = "petal-spark";

    // â™¥ / â­‘ å½¢ç‹€
    span.textContent = (Math.random() < 0.5) ? "â™¥" : "â­‘";

    // ç²‰ç´…è‰² + ä¸€é»é»å…‰æšˆ
    span.style.color = "#ff91c1"; // ç²‰ç´…
    span.style.textShadow = "0 0 6px rgba(255,145,193,0.85)";

    // å¤§å° 8~13pxï¼Œæ¯”åŸæœ¬å¤§ä¸€é»ï¼Œè¼ƒå®¹æ˜“çœ‹è¦‹
    const size = 8 + Math.random() * 5;
    span.style.setProperty("--sparkSize", size + "px");

    // è¦–è¦ºå¤§å°å¾®èª¿
    const scale = 0.9 + Math.random() * 0.5;
    span.style.setProperty("--sparkScale", scale);

    // å™´å‡ºçš„æ™‚é–“ & å»¶é²ï¼ˆè¼ƒçŸ­ï¼Œæ„Ÿè¦ºæ¯”è¼ƒã€Œè¹¦ã€ï¼‰
    const dur   = 600 + Math.random() * 600;    // 0.6 ~ 1.2 ç§’
    const delay = Math.random() * 200;          // 0 ~ 0.2 ç§’
    span.style.setProperty("--sparkDur",   dur   + "ms");
    span.style.setProperty("--sparkDelay", delay + "ms");

    // å™´å‡ºæ–¹å‘ï¼šå¾èŠ±ç“£å¤–åœå¾€å¤–é£›ï¼Œä½ç§»æ¯”åŸæœ¬å¤§
    const dx = (Math.random() * 80 - 40) + "px";     // å·¦å³ -40 ~ +40
    const dy = (-20 - Math.random() * 80) + "px";    // å¾€ä¸Š -20 ~ -100
    span.style.setProperty("--sparkDx", dx);
    span.style.setProperty("--sparkDy", dy);

    // å‡ºç¾ä½ç½®ï¼šç’°ç¹èŠ±ç“£ã€Œå¤–åœˆã€ï¼Œé¿å…å£“åœ¨èŠ±ç“£æ­£ä¸­å¤®
    const angle = Math.random() * Math.PI * 2;  // 0 ~ 2Ï€
    const radius = 70 + Math.random() * 20;     // é›¢ä¸­å¿ƒ 70%~90% çš„ç’°å¸¶
    const cx = 50 + Math.cos(angle) * radius;
    const cy = 50 + Math.sin(angle) * radius;
    span.style.left = cx + "%";
    span.style.top  = cy + "%";

    // ç›´æ¥å¡é€²èŠ±ç“£è£¡ï¼Œæœƒè·Ÿè‘—èŠ±ç“£ä¸€èµ·é£„
    el.appendChild(span);
  }
}



// ====== Overlay æ“ä½œï¼ˆå¡ç‰Œåœ¨å·¦ï¼‰ ======
function showOverlay(
  title,
  lines = [],
  {
    showCard = false,
    cardText = "+0",
    flip = false,
    cardHint = "æŠ½å¡çµæœ",
    playersList = [],
    note = "",
    stepsMap = null,
    badgeText = "",
  } = {}
) {
  overlayTitleEl.textContent = title;
  overlayLinesEl.innerHTML = "";
  for (const line of lines) {
    const d = document.createElement("div");
    d.textContent = line;
    overlayLinesEl.appendChild(d);
  }

  overlayPlayersEl.innerHTML = "";
  if (playersList && playersList.length) {
    overlayPlayersEl.hidden = false;
    for (const id of playersList) {
      const p = findPlayer(id);

      const wrap = document.createElement("div");
      wrap.className = "overlay-player";

      const a = document.createElement("div");
      a.className = "avatar-sm";
      const img = document.createElement("img");
      img.src = p.img;
      img.alt = p.name;
      a.appendChild(img);
      wrap.appendChild(a);

      if (stepsMap && typeof stepsMap[id] === "number") {
        const badge = document.createElement("div");
        badge.className = "overlay-step-badge";
        badge.textContent = `+${stepsMap[id]}`;
        wrap.appendChild(badge);
      }

      overlayPlayersEl.appendChild(wrap);
    }
  } else {
    overlayPlayersEl.hidden = true;
  }

  overlayNoteEl.textContent = note || "";

  // badgeï¼ˆMP25xx å¯©æŸ¥é€šéï¼‰
  if (overlayBadgeEl) {
    if (badgeText) {
      if (overlayBadgeEl.dataset.text !== badgeText) {
        overlayBadgeEl.dataset.text = badgeText;
        overlayBadgeEl.innerHTML =
          `<span class="overlay-badge-text">${badgeText}</span>`;
      }
      overlayBadgeEl.classList.remove("hidden");
    } else {
      overlayBadgeEl.dataset.text = "";
      overlayBadgeEl.innerHTML = "";
      overlayBadgeEl.classList.add("hidden");
    }
  }

  // å¡ç‰‡é¡¯ç¤ºï¼ç¿»é¢
  cardFrontEl.textContent = showCard ? cardText : "";
  cardHintEl.textContent  = showCard ? cardHint : "æŠ½å¡çµæœ";
  cardEl.classList.remove("flip");

  // âœ… åªè² è²¬ç¿»å¡ï¼Œä¸å†è‡ªå‹•æ”¾èŠ±ç“£
  if (showCard && flip) {
    setTimeout(() => {
      cardEl.classList.add("flip");
    }, 120);
  }
}

    // ====== å»ºç«‹è³½é“ ======
    function buildLanes(){
      lanesEl.innerHTML = "";
      players.forEach((p, index) => {
        const lane = document.createElement("div");
        lane.className = "lane";
        lane.dataset.id = p.id;

        const info = document.createElement("div");
        info.className = "lane-info";

        const order = document.createElement("div");
        order.className = "lane-order";
        order.textContent = index + 1;

        const avatar = document.createElement("div");
        avatar.className = "lane-avatar-static";
        const img = document.createElement("img");
        img.src = p.img;
        img.alt = p.name;
        avatar.appendChild(img);

        const name = document.createElement("div");
        name.className = "lane-name";
        name.textContent = p.name;

        info.appendChild(order);
        info.appendChild(avatar);
        info.appendChild(name);

        const track = document.createElement("div");
track.className = "lane-track";

// èµ·é»ç·šï¼ˆSTARTï¼‰
const startLine = document.createElement("div");
startLine.className = "lane-line lane-line-start";
const startLabel = document.createElement("div");
startLabel.className = "lane-line-label";
startLabel.textContent = "START";
startLine.appendChild(startLabel);
startLine.style.left = progressPercent(0) + "%";

// çµ‚é»ç·šï¼ˆFINISHï¼‰
const finishLine = document.createElement("div");
finishLine.className = "lane-line lane-line-finish";
const finishLabel = document.createElement("div");
finishLabel.className = "lane-line-label";
finishLabel.textContent = "FINISH";
finishLine.appendChild(finishLabel);
finishLine.style.left = progressPercent(FINISH) + "%";

// åº•ä¸‹å¡«è‰²æ¢
const bar = document.createElement("div");
bar.className = "lane-bar";

const fill = document.createElement("div");
fill.className = "lane-bar-fill";
fill.id = `bar-${p.id}`;
bar.appendChild(fill);

// è·‘å‹•é ­åƒ
const marker = document.createElement("div");
marker.className = "lane-marker";
marker.id = `marker-${p.id}`;

const mImg = document.createElement("img");
mImg.src = p.img;
mImg.alt = p.name;
marker.appendChild(mImg);

// ğŸ‘‘ å† è»çš‡å† 
const crown = document.createElement("div");
crown.className = "lane-crown";
crown.textContent = "ğŸ‘‘";
marker.appendChild(crown);

// ç›®å‰æ ¼æ•¸æ¨™ç±¤
const label = document.createElement("div");
label.className = "lane-pos-label";
label.id = `pos-${p.id}`;
label.textContent = "ğŸ¾ 0 æ ¼";
marker.appendChild(label);

/* æŠŠèµ·é»ç·šï¼†çµ‚é»ç·šçœŸçš„æ”¾é€²è³½é“è£¡ */
track.appendChild(bar);
track.appendChild(startLine);
track.appendChild(finishLine);
track.appendChild(marker);

lane.appendChild(info);
lane.appendChild(track);
lanesEl.appendChild(lane);

      });

      updateAllProgress();
    }

    function progressPercent(pos){
  // è³½é“å¯è¦‹ç¯„åœï¼ˆç™¾åˆ†æ¯”ï¼‰
  const startPct   = 4;   // 0 æ ¼æ™‚é ­åƒçš„ä½ç½®
  const finishPct  = 83;  // çµ‚é»ç·šåœ¨ç•«é¢ä¸Šçš„ä½ç½®
  const maxPct     = 92;  // é ­åƒæœ€å¤šåªåˆ°é€™è£¡ï¼Œä¸æœƒè¡å‡ºè³½é“

  // å®‰å…¨è™•ç†è² æ•¸
  if (pos <= 0) return startPct;

  // 1) çµ‚é»å‰ï¼šç¶­æŒç·šæ€§ï¼ˆ1 æ ¼ = å›ºå®šè·é›¢ï¼‰
  if (pos <= FINISH){
    const ratio = pos / FINISH; // 0 ~ 1
    return startPct + (finishPct - startPct) * ratio;
  }

  // 2) çµ‚é»å¾Œï¼šæ­¥å¹…ç¸®å°ä¸€é»ï¼Œé¿å…è·‘å¤ªé 
  const preStep   = (finishPct - startPct) / FINISH; // çµ‚é»å‰æ¯ 1 æ ¼ä½ç§»
  const afterStep = preStep * 0.7;                   // çµ‚é»å¾Œæ”¹æˆ 0.7 å€

  const extraCells = pos - FINISH;                   // è¶…éçµ‚é»å¹¾æ ¼
  const beyondPct  = finishPct + extraCells * afterStep;

  // ä¸è®“é ­åƒè¶…å‡ºè³½é“
  return Math.min(beyondPct, maxPct);
}


    function updateAllProgress(){
  players.forEach(p => {
    const pos = state.pos[p.id] ?? 0;

    const fill   = document.getElementById(`bar-${p.id}`);
    const marker = document.getElementById(`marker-${p.id}`);
    const label  = document.getElementById(`pos-${p.id}`);
    if (!fill || !marker || !label) return;

    // ä½ç½®æ›ç®—
    const pct = progressPercent(pos);
    fill.style.width  = pct + "%";
    marker.style.left = pct + "%";

    const reachedFinish = pos >= FINISH;
    const beyondFinish  = pos > FINISH;

    // å…ˆæŠŠã€Œè¶…éçµ‚é»ã€æ¨™è¨˜æ‹¿æ‰
    label.classList.remove("beyond-finish");

    // ğŸ”¹ 1) < 46 æ ¼ï¼šé¡¯ç¤º ğŸ¾ X æ ¼ï¼Œè·Ÿè‘—é ­åƒè·‘
    if (!reachedFinish){
      label.style.display = "flex";
      label.textContent   = `ğŸ¾ ${pos} æ ¼`;
    }
    // ğŸ”¹ 2) å‰›å¥½ 46 æ ¼ï¼šä¸é¡¯ç¤ºæ¨™ç±¤
    else if (pos === FINISH){
      label.style.display = "none";
    }
    // ğŸ”¹ 3) > 46 æ ¼ï¼šæ”¹æˆ ğŸš€ X æ ¼ï¼Œä¸¦å¥—ç”¨ beyond-finish è®“æ¨™ç±¤è·‘å»ç«ç®­æ—é‚Š
    else{
      label.style.display = "flex";
      label.textContent   = ` ${pos} æ ¼`;
      label.classList.add("beyond-finish");
    }

    // æ¸…æ‰èˆŠçš„å®Œæˆï¼ç«ç®­ç›¸é—œ class & å…ƒç´ 
    marker.classList.remove("finished","star-power","rainbow-power");
    const oldRocket = marker.querySelector(".lane-rocket");
    if (oldRocket) oldRocket.remove();

    // ğŸ”¸ æŠµé”çµ‚é»ï¼ˆå«è¶…éï¼‰ï¼šæœ‰å®Œæˆå…‰æšˆ + æ˜Ÿå…‰
    if (reachedFinish){
      marker.classList.add("finished","star-power");
    }

    // ğŸ”¸ è¶…éçµ‚é»ï¼šåŠ ä¸Šç«ç®­ + å½©è™¹æ®˜å½±
    if (beyondFinish){
      marker.classList.add("rainbow-power");

      const rocket = document.createElement("div");
      rocket.className = "lane-rocket";
      rocket.textContent = "ğŸš€";
      marker.appendChild(rocket);
    }
  });


  // â˜… æ¯æ¬¡æ›´æ–°è³½é“æ™‚ï¼Œé †ä¾¿æª¢æŸ¥è¦ä¸è¦åˆ‡æ› BGM
  checkRaceMusicTriggers();
  updateRivalryMarkers();
}

function updateRivalryMarkers(){
  // å·²ç¶“çµæŸå°±ç¢ºä¿å…¨éƒ¨æ¸…ä¹¾æ·¨
  if (rivalryEnded){
    players.forEach(p => {
      const marker = document.getElementById(`marker-${p.id}`);
      if (marker) marker.classList.remove("rivalry-hot");
    });
    return;
  }

  // é‚„æ²’é–‹å§‹å°±ä»€éº¼éƒ½ä¸åš
  if (!rivalryStarted) return;

  // ç«¶é€Ÿé€²è¡Œä¸­ï¼š>=38 çš„äººå¥—ç”¨ï¼›<38 çš„äººç§»é™¤
  players.forEach(p => {
    const pos = state.pos[p.id] ?? 0;
    const marker = document.getElementById(`marker-${p.id}`);
    if (!marker) return;

    if (pos >= 38 && pos < FINISH){
      marker.classList.add("rivalry-hot");
    } else {
      marker.classList.remove("rivalry-hot");
    }
  });
}

// ====== ä¾è³½æ³åˆ‡æ› BGMï¼ˆ38 æ ¼ nervous / 46 æ ¼ finishï¼‰=====
function checkRaceMusicTriggers(){
  // å¿«è½‰æ™‚å°±ä¸è¦åˆ‡æ­Œï¼Œé¿å…é‡æ’­æ™‚ä¸€ç›´è·³
  if (fastMode) return;

  // æ‰¾å‡ºç›®å‰ã€Œæœ€å‰é¢ã€çš„é‚£ä½é¸æ‰‹ä½ç½®
  let maxPos = 0;
  players.forEach(p => {
    const pos = state.pos[p.id] ?? 0;
    if (pos > maxPos) maxPos = pos;
  });

  // å¦‚æœå·²ç¶“å•Ÿå‹•éçµ‚é» BGMï¼Œå°±ç¶­æŒ finishï¼Œä¸å†æ”¹
  if (finishStarted){
    return;
  }

  // â­ ç¬¬ä¸€æ¬¡æœ‰äººåˆ°é”æˆ–è¶…éçµ‚é»ï¼šæ¨™è¨˜ finish + çµæŸç«¶é€Ÿæ•ˆæœ
  if (maxPos >= FINISH){
    finishStarted = true;

    // çµæŸ 38~46 ç«¶é€Ÿç«ç„°æ•ˆæœ
    rivalryEnded   = true;
    rivalryStarted = false;
    updateRivalryMarkers(); // æŠŠå…¨éƒ¨äººçš„ rivalry-hot æ‹¿æ‰

    // æ³¨æ„ï¼šçœŸæ­£æ’­æ”¾ finish BGM äº¤çµ¦ celebrateFinish() è™•ç†
    return;
  }

  // â­ é‚„æ²’åˆ°çµ‚é»ï¼Œä¸”ç¬¬ä¸€æ¬¡æœ‰äººé€²å…¥ 38 æ ¼å€é–“ï¼šå•Ÿå‹•ç«¶é€Ÿæ•ˆæœ + nervous BGM
  if (maxPos >= 38){
    // ç«¶é€Ÿç«ç„°åªå•Ÿå‹•ä¸€æ¬¡
    if (!rivalryStarted && !rivalryEnded){
      rivalryStarted = true;
      updateRivalryMarkers();
    }

    // nervous BGM åªå•Ÿå‹•ä¸€æ¬¡
    if (!nervousStarted){
  nervousStarted = true;
  playMainBgm("nervous");   // âœ… ç·Šå¼µ BGM é€²å…¥å¾Œä¸€è·¯ loop åˆ° 46
}
  }

  // å…¶ä»–æƒ…æ³å°±ç¶­æŒåŸæœ¬ BGMï¼ˆnormal æˆ– nervousï¼‰ï¼Œä¸ç‰¹åˆ¥è™•ç†
}

    // ====== å»ºç«‹å³å´ã€Œå›åˆå¿«é€Ÿè·³è½‰ã€æŒ‰éˆ• ======
    function buildRoundJumpButtons(){
      if (!roundJumpButtonsEl) return;
      roundJumpButtonsEl.innerHTML = "";

      rounds.forEach(r => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "round-jump-btn";
        btn.textContent = `ç¬¬ ${r.round} å›åˆ`;
        btn.addEventListener("click", () => {
          jumpToRound(r.round);
        });
        roundJumpButtonsEl.appendChild(btn);
      });
    }

    // ====== æ’åï¼ˆå³å´åˆ—è¡¨ï¼‰ ======
    function getOrderedPlayers(){
      return [...players].sort((a,b)=>{
        const pa = state.pos[a.id];
        const pb = state.pos[b.id];
        if (pb !== pa) return pb - pa;
        return players.findIndex(x=>x.id===a.id) - players.findIndex(x=>x.id===b.id);
      });
    }

    function updateRank(){
  const ordered = getOrderedPlayers();

  // å…ˆç®—æ¯å€‹äººçš„åæ¬¡è®Šå‹•ï¼ˆåªæ˜¯ç”¨ä¾†ç®— â†‘â†“ å’Œåˆ¤æ–·æœ‰æ²’æœ‰äººè®Šå‹•ï¼‰
  const diffs   = new Map();       // id -> diffï¼ˆèˆŠåæ¬¡ - æ–°åæ¬¡ï¼‰
  let anyMoved  = false;           // é€™ä¸€è¼ªæœ‰æ²’æœ‰äººåæ¬¡æœ‰è®Š
  const hadPrev = prevRankIndex.size > 0;

  ordered.forEach((p, i) => {
    const oldIdx = prevRankIndex.has(p.id) ? prevRankIndex.get(p.id) : i;
    const diff   = oldIdx - i;  // æ­£æ•¸ä»£è¡¨åæ¬¡ä¸Šå‡
    diffs.set(p.id, diff);
    if (diff !== 0) anyMoved = true;
  });

  const frag = document.createDocumentFragment();

  ordered.forEach((p, i) => {
    let li = rankCache.get(p.id);

    // ç¬¬ä¸€æ¬¡å»ºç«‹ li
    if (!li){
      li = document.createElement("li");

      const left = document.createElement("div");
      left.className = "name";

      const avatarWrap = document.createElement("div");
      avatarWrap.className = "rank-avatar-wrap";

      const img = document.createElement("img");
      img.src = p.img;
      img.alt = p.name;

      const crown = document.createElement("div");
      crown.className = "rank-crown";
      crown.textContent = "ğŸ‘‘";

      avatarWrap.appendChild(img);
      avatarWrap.appendChild(crown);

      const nameWrap = document.createElement("div");
      nameWrap.className = "rank-name-wrap";

      const title = document.createElement("div");
      title.className = "rank-title";

      const delta = document.createElement("span");
      delta.className = "rank-delta";

      nameWrap.appendChild(title);
      nameWrap.appendChild(delta);

      left.appendChild(avatarWrap);
      left.appendChild(nameWrap);

      const right = document.createElement("div");
      right.className = "pos";

      li.appendChild(left);
      li.appendChild(right);

      rankCache.set(p.id, li);
    }

    // æ›´æ–°å³å´æ ¼æ•¸
    const curPos = state.pos[p.id];
    li.querySelector(".pos").textContent =
      curPos > FINISH ? `ğŸš€ ${curPos} æ ¼` : `ğŸ¾ ${curPos} æ ¼`;

    // åæ¬¡æ–‡å­—
    li.querySelector(".rank-title").textContent = `${i+1}. ${p.name}`;

    // å† è»çš‡å† ï¼ˆåªçµ¦ç¬¬ä¸€å€‹åˆ°é”çµ‚é»çš„äººï¼‰
    const crownEl = li.querySelector(".rank-crown");
    if (crownEl){
      const isWinner = !!state.finished && (p.id === state.finished);
      crownEl.classList.toggle("show", isWinner);
    }

    // åæ¬¡è®Šå‹• diff â†’ é¡¯ç¤º â†‘â†“ å¾½ç« 
    const diff    = diffs.get(p.id) || 0;
    const deltaEl = li.querySelector(".rank-delta");

    deltaEl.className     = "rank-delta"; // é‡ç½® class
    deltaEl.style.display = "none";
    deltaEl.textContent   = "";

    // é è¨­æ²’æœ‰ä¸Šå‡
    li.dataset.rankUp = (diff > 0) ? "1" : "0";
    // ğŸ”¹ åæ¬¡æŒå¹³ï¼ˆè€Œä¸”é€™ä¸€è¼ªæœ‰ä»»ä½•äººè®Šå‹• & ä¸æ˜¯ç¬¬ä¸€æ¬¡æ’åºï¼‰å°±æ¨™è¨˜èµ·ä¾†
    li.dataset.rankSame = (diff === 0 && hadPrev && anyMoved) ? "1" : "0";

    if (diff > 0){
      deltaEl.textContent = `â†‘ +${diff}`;
      deltaEl.classList.add("up");
      deltaEl.style.display = "inline-flex";
    }else if (diff < 0){
      deltaEl.textContent = `â†“ ${-diff}`;
      deltaEl.classList.add("down");
      deltaEl.style.display = "inline-flex";
    }

    // æ²’æœ‰è®Šå‹•çš„åæ¬¡ï¼Œåœ¨ã€Œä¸æ˜¯ç¬¬ä¸€æ¬¡æ’åºã€ä¸”ã€Œé€™ä¸€è¼ªæœ‰äººè®Šå‹•ã€æ™‚æ·¡åŒ–
    if (hadPrev && anyMoved && diff === 0){
      li.classList.add("rank-static");
    }else{
      li.classList.remove("rank-static");
    }

    // ä¸å†ä½¿ç”¨ rank-pop / rank-moving çš„ FLIP æµ®å‡ºå‹•ç•«
    li.classList.remove("rank-pop", "rank-moving");

    frag.appendChild(li);
  });

  // é‡æ–°æ›å›å»ï¼ˆç…§æ–°æ’åºï¼‰
  rankEl.replaceChildren(frag);

  // â­ å³â†’å·¦ä¸€å€‹ä¸€å€‹æ»‘é€²ä¾†çš„å‹•ç•«
      const items = Array.from(rankEl.children);
  items.forEach((li, index) => {
    // fastMode æ™‚å°±ä¸è¦åšé€²å ´ï¼‹ç™¼å…‰å‹•ç•«ï¼Œå…å¾—å¡å¡
    if (fastMode){
      li.style.opacity   = "1";
      li.style.transform = "translateX(0)";
      li.style.transition = "none";
      return;
    }

    // åˆå§‹ç‹€æ…‹ï¼šé€æ˜ï¼‹åœ¨å³é‚Šä¸€é»
    li.style.opacity   = "0";
    li.style.transform = "translateX(32px)";
    li.style.transition = "none";

    const baseDelay   = index * 70;   // æ»‘é€²ä¾†çš„å»¶é²
    const slideDur    = 420;          // ä¸Šé¢ transition çš„æ™‚é–“
    const shineDelay  = baseDelay + slideDur; // æ»‘å®Œå†ç™¼å…‰

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        li.style.transition =
          "transform 420ms ease-out, opacity 420ms ease-out";
        li.style.transitionDelay = `${baseDelay}ms`;
        li.style.opacity   = "1";
        li.style.transform = "translateX(0)";
      });
    });

    const isRankUp   = (li.dataset.rankUp === "1");
    const isRankSame = (li.dataset.rankSame === "1");

    // ğŸ”¹ åæ¬¡æŒå¹³ â†’ éŠ€è‰²é‡‘å±¬å…‰æ¾¤
    if (isRankSame){
      setTimeout(() => {
        li.classList.add("rank-same-glow");
        setTimeout(() => {
          li.classList.remove("rank-same-glow");
        }, 800);
      }, shineDelay);
    }

    // ğŸ”¹ åæ¬¡ä¸Šå‡ â†’ è—è‰²é‡‘å±¬å…‰æ¾¤ï¼ˆåŸæœ¬é€™æ®µï¼‰
    if (isRankUp){
      setTimeout(() => {
        li.classList.add("rank-up-glow");
        setTimeout(() => {
          li.classList.remove("rank-up-glow");
        }, 800);
      }, shineDelay);
    }
  });




  // æ›´æ–°ã€Œä¸Šä¸€è¼ªåæ¬¡ã€è¨˜éŒ„ï¼Œçµ¦ä¸‹ä¸€æ¬¡æ¯”è¼ƒç”¨
  prevRankIndex = new Map(ordered.map((p, i) => [p.id, i]));
}

// ====== é€šé—œæ’åï¼ˆæŠµé”çµ‚é»é †åºï¼‰ ======
function updateClearRank(){
  if (!clearRankSectionEl || !clearRankListEl) return;

  const order = state.finishOrder;

  // é‚„æ²’æœ‰äººåˆ°çµ‚é»ï¼šæ•´å¡Šå€åŸŸéš±è—
  if (!order.length){
    clearRankSectionEl.hidden = true;
    clearRankListEl.innerHTML = "";
    return;
  }

  // æœ‰äººåˆ°çµ‚é»ï¼šé¡¯ç¤ºå€å¡Š
  clearRankSectionEl.hidden = false;
  clearRankListEl.innerHTML = "";

  order.forEach((id, idx) => {
    const p = findPlayer(id);
    if (!p) return;

    const li = document.createElement("li");

    const left = document.createElement("div");
    left.className = "name";

    const avatarWrap = document.createElement("div");
    avatarWrap.className = "rank-avatar-wrap";

    const img = document.createElement("img");
    img.src = p.img;
    img.alt = p.name;
    avatarWrap.appendChild(img);

    // åªåœ¨é€šé—œç¬¬ä¸€åé ­ä¸Šæˆ´çš‡å† 
    if (idx === 0){
      const crown = document.createElement("div");
      crown.className = "rank-crown show";
      crown.textContent = "ğŸ‘‘";
      avatarWrap.appendChild(crown);
    }

    const title = document.createElement("div");
    title.textContent = `${idx + 1}. ${p.name}`;

    left.appendChild(avatarWrap);
    left.appendChild(title);

    const right = document.createElement("div");
    right.className = "pos";
    right.textContent =
      state.pos[id] > FINISH ? `ğŸš€ ${state.pos[id]} æ ¼` : `ğŸ¾ ${state.pos[id]} æ ¼`;

    li.appendChild(left);
    li.appendChild(right);

    clearRankListEl.appendChild(li);
  });
}

    // ====== ç„¦é»æ•ˆæœ ======
    function setFocus(focusIds){
      const set = new Set(focusIds);
      players.forEach(p=>{
        const lane = document.querySelector(`.lane[data-id="${p.id}"]`);
        if (!lane) return;
        lane.classList.remove("dim","focus");
        if (focusIds.length){
          if (set.has(p.id)) lane.classList.add("focus");
          else lane.classList.add("dim");
        }
      });
    }
    function clearFocus(){
      players.forEach(p=>{
        const lane = document.querySelector(`.lane[data-id="${p.id}"]`);
        if (!lane) return;
        lane.classList.remove("dim","focus");
      });
    }

    // ====== é“å…·ç‰¹æ•ˆï¼ˆæŠ½å¡ç”¨ï¼šèŠ±ç“£é£„è½ï¼‰ ======
function playItemFx(style){
  if (fastMode) return;

  itemFxEl.innerHTML = "";
  itemFxEl.style.display = "block";

  const originEl = cardAreaEl;
  if (!originEl) return;

  const rect = originEl.getBoundingClientRect();
  const vw   = window.innerWidth;
  const vh   = window.innerHeight;

  const baseX = (rect.left + rect.width  / 2) / vw * 100; // 0~100
  const baseY = (rect.top  + rect.height / 2) / vh * 100; // 0~100

  const count = 8;

  let maxEnd = 0;

  for (let i = 0; i < count; i++) {
    const s = document.createElement("div");
    s.className = "track-star";

    // âœ… é€™è£¡æ”¹æˆç¬¦åˆä½  CSS æœƒç”¨åˆ°çš„è®Šæ•¸ï¼š--dur --delay --drift --r0 --r1 --alpha --blur
    const size  = 40 + Math.random() * 28; // 40~68px
    const durMs = 6500 + Math.random() * 3500;      // 2.6~4.2sï¼ˆä½ è¦æ›´æ…¢å°±åŠ å¤§ï¼‰
    const delay = Math.random() * 260;              // 0~260ms
    const drift = 22 + Math.random() * 38;          // å·¦å³æ“ºå‹•å¹…åº¦
    const r0    = (Math.random() * 360) + "deg";
    const r1    = (Math.random() * 360) + "deg";
    const alpha = 0.35 + Math.random() * 0.25;      // 0.35~0.60
    const blur  = Math.random() < 0.45 ? (1 + Math.random() * 2) : 0; // é æ™¯ç•¥ç³Š

    // ä½ç½®ï¼šå¾å¡ç‰Œé™„è¿‘é–‹å§‹
    s.style.setProperty("--x", baseX + "vw");
    s.style.setProperty("--y", baseY + "vh");


    s.style.setProperty("--size",  size + "px");
    s.style.setProperty("--dur",   durMs + "ms");
    s.style.setProperty("--delay", delay + "ms");
    s.style.setProperty("--drift", drift + "px");
    s.style.setProperty("--r0",    r0);
    s.style.setProperty("--r1",    r1);
    s.style.setProperty("--alpha", alpha);
    s.style.setProperty("--blur",  blur + "px");

    itemFxEl.appendChild(s);

    maxEnd = Math.max(maxEnd, durMs + delay);
  }

  // âœ… ä¸è¦å›ºå®š 1800msï¼Œæ”¹æˆç­‰å‹•ç•«çœŸçš„è·‘å®Œå†æ¸…
  setTimeout(() => {
    itemFxEl.style.display = "none";
    itemFxEl.innerHTML = "";
  }, maxEnd + 200);
}

    // ====== é§±é§ä½¿ç”¨å‰é€²å¡ï¼šè³½é“ + å­—å¹•å¡é›™é‡èŠ±ç“£ ======
function playCamelUseFx(){
  if (fastMode) return;

  itemFxEl.innerHTML = "";
  itemFxEl.style.display = "block";

  const origins = [];
  const camelMarker = document.getElementById("marker-camel");
  if (camelMarker) origins.push(camelMarker);
  if (overlayEl) origins.push(overlayEl);

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  let maxEnd = 0;

  origins.forEach(originEl => {
    const rect = originEl.getBoundingClientRect();
    const baseX = (rect.left + rect.width  / 2) / vw * 100;
    const baseY = (rect.top  + rect.height / 2) / vh * 100;

    const count = 10;

    for (let i = 0; i < count; i++) {
      const s = document.createElement("div");
      s.className = "track-star";

      const size  = 42 + Math.random() * 30; // 42~72px
      const durMs = 7000 + Math.random() * 4000;
      const delay = Math.random() * 260;
      const drift = 26 + Math.random() * 46;
      const r0    = (Math.random() * 360) + "deg";
      const r1    = (Math.random() * 360) + "deg";
      const alpha = 0.35 + Math.random() * 0.25;
      const blur  = Math.random() < 0.45 ? (1 + Math.random() * 2) : 0;

      s.style.setProperty("--x", baseX + "vw");
      s.style.setProperty("--y", baseY + "vh");


      s.style.setProperty("--size",  size + "px");
      s.style.setProperty("--dur",   durMs + "ms");
      s.style.setProperty("--delay", delay + "ms");
      s.style.setProperty("--drift", drift + "px");
      s.style.setProperty("--r0",    r0);
      s.style.setProperty("--r1",    r1);
      s.style.setProperty("--alpha", alpha);
      s.style.setProperty("--blur",  blur + "px");

      itemFxEl.appendChild(s);

      maxEnd = Math.max(maxEnd, durMs + delay);
    }
  });

  setTimeout(() => {
    itemFxEl.style.display = "none";
    itemFxEl.innerHTML = "";
  }, maxEnd + 200);
}


        // ====== å¤©ä½¿ç‰¹æ•ˆï¼šangel-wing ç¾½æ¯›å¾ä¸Šå¾€ä¸‹ + æ„›å¿ƒåœ¨é¸æ‰‹é ­åƒä¸Š ======
function playAngelFx(targetIds = []){
  if (fastMode) return Promise.resolve();

  // â˜… æ’­æ”¾ä¸€æ¬¡é­”æ³•éŸ³æ•ˆï¼ˆæœƒå›å‚³ Promiseï¼‰
  const magicPromise = playMagicOnce();

  itemFxEl.innerHTML = "";
  itemFxEl.style.display = "block";

  if (!overlayEl) return magicPromise;

  const rect = overlayEl.getBoundingClientRect();

  const layer = document.createElement("div");
  layer.className = "angel-layer";
  itemFxEl.appendChild(layer);

  const featherCount      = 18;
  const FEATHER_MAX_DUR   = 2400;
  const FEATHER_DELAY_MAX = 380;

  for (let i = 0; i < featherCount; i++){
    const f = document.createElement("div");
    f.className = "angel-feather";

    const isNear = Math.random() < 0.55;
    f.classList.add(isNear ? "near" : "far");

    if (Math.random() < 0.5){
      f.classList.add("flip");
    }
    if (Math.random() < 0.5){
      f.classList.add("right");
    }

    const ratioX = 0.02 + Math.random() * 0.96;
    const startX = rect.left + rect.width * ratioX;

    const startY = rect.top - (isNear ? 120 : 80) - Math.random() * 60;

    f.style.left = startX + "px";
    f.style.top  = startY + "px";

    const scale = isNear
      ? 0.8 + Math.random() * 0.25
      : 0.55 + Math.random() * 0.20;
    f.style.setProperty("--scale", scale);
    f.style.setProperty("--rotStart", (Math.random() * 30 - 15) + "deg");
    f.style.setProperty("--rotEnd",   (Math.random() * 30 - 15) + "deg");

    const dur = isNear
      ? 2000 + Math.random() * 400
      : 1600 + Math.random() * 300;
    f.style.setProperty("--dur", dur + "ms");
    f.style.animationDelay = (Math.random() * FEATHER_DELAY_MAX) + "ms";

    layer.appendChild(f);
  }

  const bubbleDelay = (FEATHER_MAX_DUR * 0.5) + (FEATHER_DELAY_MAX * 0.5);

  setTimeout(() => {
    const ids = Array.isArray(targetIds) ? targetIds : [];
    if (!ids.length) return;

    ids.forEach(id => {
      const marker = document.getElementById(`marker-${id}`);
      if (!marker) return;

      const mr = marker.getBoundingClientRect();
      const baseX = mr.left + mr.width  / 2;
      const baseY = mr.top  + mr.height / 2;

      const bubbleCount = 6;
      for (let i = 0; i < bubbleCount; i++){
        const b = document.createElement("div");
        b.className = "angel-bubble";

        const big  = Math.random() < 0.4;
        const size = big ? 20 : 15;
        b.style.width  = size + "px";
        b.style.height = size + "px";

        b.style.left = baseX + "px";
        b.style.top  = baseY + "px";

        const angle = Math.random() * Math.PI * 2;
        const dist  = 40 + Math.random() * 30;
        const dx    = Math.cos(angle) * dist;
        const dy    = Math.sin(angle) * dist;

        b.style.setProperty("--dx", dx + "px");
        b.style.setProperty("--dy", dy + "px");

        b.style.animationDelay = (Math.random() * 200) + "ms";

        layer.appendChild(b);
      }
    });
  }, bubbleDelay);

  const totalDuration = bubbleDelay + 1500 + 200;

  // âœ… å›å‚³ä¸€å€‹ Promiseï¼šæ•´å€‹ç¾½æ¯›ï¼‹æ³¡æ³¡çµæŸå¾Œï¼Œé †ä¾¿æŠŠåœ–å±¤æ¸…æ‰
  const fxPromise = new Promise(resolve => {
    setTimeout(() => {
      itemFxEl.style.display = "none";
      itemFxEl.innerHTML = "";
      resolve();
    }, totalDuration);
  });

  return Promise.all([magicPromise, fxPromise]);
}


    // ====== ç¬¬ä¸€åç…™ç«ï¼šé€£çºŒæ”¾ totalMs æ¯«ç§’ ======
function playFireworks(totalMs = 3000){
  if (fastMode) return;

  fireworksEl.innerHTML = "";
  fireworksEl.style.display = "block";

  const colors = ["#ff6b6b","#ffd166","#4ea1ff","#9d4edd","#4ad66d","#ff8fab","#00d4ff"];

  // åˆ†å±¤ï¼šå¤§ã€ä¸­ã€å°ï¼ˆåŒä¸€æ³¢ burst è£¡æ··åˆï¼‰
  const layers = [
    { name:"big",   count:18, sz:[8,12],  dist:[90,140],  dur:[1100,1500], z:98 },
    { name:"mid",   count:26, sz:[5,8],   dist:[60,110],  dur:[900,1300],  z:97 },
    { name:"small", count:34, sz:[3,6],   dist:[35,80],   dur:[750,1100],  z:96 },
  ];

  function rand(min,max){ return min + Math.random() * (max-min); }
  function pick(arr){ return arr[(Math.random()*arr.length)|0]; }
  function randRange(min, max){ return min + Math.random() * (max - min); }

  function spawnBurst(){
    // âœ… éš¨æ©Ÿå…¨è¢å¹•æ•£ä½ˆï¼ˆç•™é‚Šç•Œï¼Œé¿å…å¤ªè²¼é‚Šï¼‰
    const cx = rand(8, 92);
    const cy = rand(8, 75);

    // âœ… æ¯ä¸€æ³¢ä¸­å¿ƒä¹Ÿåšã€ŒåŸåœ°è·³ä¸€ä¸‹ã€
    const shock = document.createElement("div");
    shock.className = "fw-spark";
    shock.style.left = cx + "vw";
    shock.style.top  = cy + "vh";
    shock.style.setProperty("--sz", rand(14, 20) + "px");
    shock.style.setProperty("--clr", pick(colors));
    shock.style.setProperty("--dx", "0px");
    shock.style.setProperty("--dy", "0px");
    shock.style.setProperty("--dur", "520ms");
    shock.style.setProperty("--delay", rand(0, 80) + "ms");
    shock.style.setProperty("--z", 99);
    shock.style.boxShadow = "0 0 26px rgba(255,255,255,.9), 0 0 44px var(--clr)";
    fireworksEl.appendChild(shock);

    layers.forEach(layer=>{
      for (let i=0; i<layer.count; i++){
        const spark = document.createElement("div");
        spark.className = "fw-spark";
        spark.style.left = cx + "vw";
        spark.style.top  = cy + "vh";

        const angle = Math.random() * Math.PI * 2;
        const dist  = rand(layer.dist[0], layer.dist[1]);

        const dx = Math.cos(angle) * dist + rand(-10,10);
        const dy = Math.sin(angle) * dist + rand(-10,10);

        spark.style.setProperty("--dx", `${randRange(-80, 80)}px`);
        spark.style.setProperty("--dy", `${randRange(-80, 80)}px`);
        spark.style.setProperty("--clr", pick(colors));
        spark.style.setProperty("--sz", rand(layer.sz[0], layer.sz[1]) + "px");
        spark.style.setProperty("--dur", rand(layer.dur[0], layer.dur[1]) + "ms");
        spark.style.setProperty("--delay", rand(0, 220) + "ms");
        spark.style.setProperty("--z", layer.z);

        fireworksEl.appendChild(spark);
      }
    });
  }

  // ä¸€é–‹å§‹å°±ä¾†å…©æ³¢ï¼Œç•«é¢æ›´æ»¿
  spawnBurst();
  setTimeout(spawnBurst, 180);

  // âœ… æ›´é »ç¹ã€ä½†æ¯æ³¢éš¨æ©Ÿï¼ˆçœ‹èµ·ä¾†æ›´è¯éº—ï¼‰
  const interval = setInterval(spawnBurst, 320);

  setTimeout(()=>{
    clearInterval(interval);
    setTimeout(() => {
      fireworksEl.style.display = "none";
      fireworksEl.innerHTML = "";

    }, 1200);   // ç•™ä¸€é»æ™‚é–“è®“æœ€å¾Œä¸€æ³¢æ”¶å°¾
  }, totalMs);
}


// ====== å† è»è³½é“å¤–æ¡†å››æ•£å™´æ˜Ÿæ˜Ÿ ======
function burstWinnerStars(lane){
  if (fastMode) return;
  if (!lane || !stageEl) return;

  // ä»¥æ•´æ¢ .laneï¼ˆæœ‰å¤–åœˆé«˜å…‰é‚£ä¸€åœˆï¼‰ç•¶åŸºæº–
  const rect = lane.getBoundingClientRect();
  const stageRect = stageEl.getBoundingClientRect();

  const count = 42;  // æ˜Ÿæ˜Ÿé¡†æ•¸

  for (let i = 0; i < count; i++){
    const star = document.createElement("div");
    star.className = "star-explode";

    const glyph = Math.random() < 0.5 ? "â˜…" : "â‹†";
    star.textContent = glyph;

    // æ±ºå®šæ˜Ÿæ˜Ÿå¾å“ªä¸€é‚Šå†’å‡ºä¾†ï¼ˆä¸Š / ä¸‹ / å·¦ / å³ï¼‰
    const edge = Math.random();
    let x, y;

    if (edge < 0.25){
      // ä¸Šé‚Š
      x = rect.left + Math.random() * rect.width;
      y = rect.top;
    }else if (edge < 0.5){
      // ä¸‹é‚Š
      x = rect.left + Math.random() * rect.width;
      y = rect.bottom;
    }else if (edge < 0.75){
      // å·¦é‚Š
      x = rect.left;
      y = rect.top + Math.random() * rect.height;
    }else{
      // å³é‚Š
      x = rect.right;
      y = rect.top + Math.random() * rect.height;
    }

    // è½‰æˆä»¥ .stage ç‚ºåŸºæº–çš„åº§æ¨™
    const relX = x - stageRect.left;
    const relY = y - stageRect.top;
    star.style.left = relX + "px";
    star.style.top  = relY + "px";

    // å™´å°„æ–¹å‘èˆ‡è·é›¢
    const angle = Math.random() * Math.PI * 2;
    const dist  = 60 + Math.random() * 60;

    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;

    star.style.setProperty("--dx", dx + "px");
    star.style.setProperty("--dy", dy + "px");

    stageEl.appendChild(star);

    setTimeout(() => {
      star.remove();
    }, 900);
  }
}


    // ====== ç§»å‹•å‹•ç•« ======
    async function moveMany(ids, stepsMap, {focusIds = []} = {}){
      setFocus(focusIds);

      const before = {};
      ids.forEach(id => before[id] = state.pos[id]);

      ids.forEach(id=>{
        const add = stepsMap[id] ?? 0;
        state.pos[id] = Math.min(state.pos[id] + add, TRACK_CELLS);
      });

      let newlyFinishedChampion = null;

for (const id of ids){
  const wasBefore = before[id];
  const nowPos    = state.pos[id];

  // é€™ä¸€å°æ­¥è£¡ï¼Œå¾æœªé”çµ‚é» â†’ æŠµé”æˆ–è¶…éçµ‚é»
  if (wasBefore < FINISH && nowPos >= FINISH){
    // é‚„æ²’è¨˜éŒ„éçš„äººæ‰åŠ å…¥ finishOrder
    if (!state.finishOrder.includes(id)){
      state.finishOrder.push(id);

      // ç¬¬ä¸€å€‹é€šé—œçš„äººï¼šè¨˜æˆå† è»ï¼Œç­‰ä¸€ä¸‹æ”¾ç…™ç«ã€æ©«å¹…
      if (!state.finished){
        state.finished = id;
        newlyFinishedChampion = id;
      }
    }
  }
}


      const duration = 600 / state.speed;
      ids.forEach(id=>{
        const fill   = document.getElementById(`bar-${id}`);
        const marker = document.getElementById(`marker-${id}`);
        if (!fill || !marker) return;
        fill.style.transition   = `width ${duration}ms ease-out`;
        marker.style.transition = `left  ${duration}ms ease-out`;
      });

      updateAllProgress();

      await sleep(duration + 80);
      clearFocus();
      updateRank();
      updateClearRank();

      if (newlyFinishedChampion){
  await celebrateFinish(newlyFinishedChampion);
}
    }

    // ====== å»ºç«‹æ’­æ”¾æ­¥é©Ÿ ======
    function dateKey(str){
      const [m, d] = (str || "").split("/").map(x => parseInt(x, 10) || 0);
      return m * 100 + d;
    }

    function computeMove(ev){
      const moveIds = [];
      const stepsMap = {};
      if (ev.type === "all"){
        players.forEach(p=>{
          moveIds.push(p.id);
          stepsMap[p.id] = ev.points ?? 0;
        });
      }else if (ev.type === "allExcept"){
        const ex = new Set(ev.except || []);
        players.forEach(p=>{
          if (!ex.has(p.id)){
            moveIds.push(p.id);
            stepsMap[p.id] = ev.points ?? 0;
          }
        });
      }else if (ev.type === "only"){
        (ev.only || []).forEach(id=>{
          moveIds.push(id);
          stepsMap[id] = ev.points ?? 0;
        });
      }else if (ev.type === "byMap"){
        Object.entries(ev.by || {}).forEach(([id, step])=>{
          moveIds.push(id);
          stepsMap[id] = step;
        });
      }
      return {moveIds, stepsMap};
    }

    function buildStepsFromRounds(){
      const steps = [];

      state.roundStartStep = {};

      for (const r of rounds){

        state.roundStartStep[r.round] = steps.length;

        // å›åˆé–‹å ´
        steps.push(async ()=>{
          showOverlay(`ç¬¬ ${r.round} å›åˆ`, ["æœ¬å›åˆé–‹å§‹"]);
          await sleep(700 / state.speed);
        });

        const allEvents = [];

        r.groupEvents.forEach((ev, idx) => {
          allEvents.push({
            kind: "group",
            ev,
            date: ev.date,
            orderIdx: idx
          });
        });

        r.soloEvents.forEach((s, idx) => {
          allEvents.push({
            kind: "solo",
            ev: s,
            date: s.date,
            orderIdx: 100 + idx
          });
        });

        allEvents.sort((a, b) => {
          const ka = dateKey(a.date);
          const kb = dateKey(b.date);
          if (ka !== kb) return ka - kb;
          return a.orderIdx - b.orderIdx;
        });

        for (const entry of allEvents){
          if (entry.kind === "group"){
            const ev = entry.ev;

            steps.push(async ()=>{
              const line1 = `${ev.date}ï¼${ev.item}`;
              let line2 = "";
              if (ev.type === "all"){
                line2 = ev.note ?? `å…¨é«” +${ev.points}`;
              }else if (ev.type === "allExcept"){
                const names = (ev.except || []).map(findName).join("ã€");
                line2 = ev.note ?? `é™¤ï¼š${names} å…¶é¤˜ +${ev.points}`;
              }else if (ev.type === "only"){
                const names = (ev.only || []).map(findName).join("ã€");
                line2 = ev.note ?? `åƒ…ï¼š${names} +${ev.points}`;
              }else if (ev.type === "byMap"){
                const cnt = Object.keys(ev.by || {}).length;
                line2 = ev.note ?? `å…± ${cnt} ä½é¸æ‰‹ç²å¾—ä¸åŒæ­¥æ•¸`;
              }

              const {moveIds, stepsMap} = computeMove(ev);

              showOverlay(`ç¬¬ ${r.round} å›åˆ`, [line1, line2], {
  playersList: moveIds,
  stepsMap: ev.type === "byMap" ? stepsMap : null
});

if (ev.fx === "angel"){
  // â­ ç­‰å¤©ä½¿ç¾½æ¯› + é­”æ³•éŸ³æ•ˆæ’­å®Œï¼Œå†é€²ä¸‹ä¸€æ®µ
  await playAngelFx(moveIds);
} else {
  await sleep(900 / state.speed);
}

            });

            steps.push(async ()=>{
              const {moveIds, stepsMap} = computeMove(ev);
              if (!moveIds.length){
                showOverlay(`ç¬¬ ${r.round} å›åˆ`, ["ï¼ˆæœ¬é …ç›®ç„¡äººç§»å‹•ï¼‰"]);
                await sleep(550 / state.speed);
                return;
              }
              showOverlay(`ç¬¬ ${r.round} å›åˆ`, ["é¸æ‰‹å‰é€²ä¸­â€¦"], {
                playersList: moveIds
              });
              await moveMany(moveIds, stepsMap, {focusIds: moveIds});
              await sleep(260 / state.speed);
            });

          } else {
            const s = entry.ev;

            const isCamelBonus = s.camelBonus === true;
            const isCamelUse   = s.camelUse === true;
            const reasonText   = s.reason || "ææ¡ˆå¯©æŸ¥é€šé";

            if (isCamelBonus){
              steps.push(async ()=>{
                const whoName = findName(s.who);
                const lines = [
                  `${whoName}ï¼Œ${s.date}`,
                  "æº–å‚™æŠ½å¡â€¦"
                ];
                showOverlay(`ç¬¬ ${r.round} å›åˆ`, lines, {
                  showCard: true,
                  cardText: "",
                  flip: false,
                  cardHint: "æº–å‚™æŠ½å‡ºå‰é€²å¡",
                  playersList: [s.who],
                  badgeText: reasonText,
                });
                await sleep(900 / state.speed);
              });

              steps.push(async ()=>{
  const whoName = findName(s.who);
  showOverlay(`ç¬¬ ${r.round} å›åˆ`, [
    `${whoName} æŠ½åˆ°ã€Œå‰é€²å¡ã€ï¼`
  ], {
    showCard: true,
    cardText: "å‰é€²å¡",
    flip: true,
    cardHint: "ç²å¾—å‰é€²å¡",
    playersList: [s.who],
    badgeText: reasonText,
  });

  // â­ ç›´æ¥ç­‰ã€Œæ«»èŠ±é›¨ï¼‹é­”æ³•éŸ³æ•ˆã€çµæŸ
  await playCardPetalsOnce();
});


                steps.push(async ()=>{
                const whoName = findName(s.who);
                showOverlay(`ç¬¬ ${r.round} å›åˆ`, [
                  `${whoName} ç²å¾—ã€Œå‰é€²å¡ã€ï¼Œå¯æ–¼ä¹‹å¾Œä½¿ç”¨ã€‚`,
                  "æœ¬æ¬¡åœç•™åŸåœ°ã€‚"
                ]);                          // â† ä¸å†å¸¶ badgeText
                await sleep(600 / state.speed);
              });

              continue;
            }

            else if (isCamelUse){
  // â‘  ä½¿ç”¨å‰é€²å¡ï¼šç¿»å¡ï¼‹æ«»èŠ±
steps.push(async ()=>{
  const whoName = findName(s.who);

  showOverlay(`ç¬¬ ${r.round} å›åˆ`, [
    `${whoName} ä½¿ç”¨å…ˆå‰ä¿ç•™çš„ã€Œå‰é€²å¡ã€ã€‚`,
    `é€™æ¬¡å°‡å‰é€² ${s.card} æ ¼ï¼`
  ], {
    showCard: true,
    cardText: `+${s.card}`,
    flip: true,
    cardHint: "ä½¿ç”¨å‰é€²å¡",
    playersList: [s.who],
    badgeText: reasonText,
  });

  // â­ ç­‰æ«»èŠ±é›¨ï¼‹éŸ³æ•ˆæ’­å®Œï¼Œå†è®“å­—å¹•å¾€ä¸‹èµ°
  await playCardPetalsOnce();
  // å¦‚æœä½ è¦åŒæ™‚è·‘å…¨ç•«é¢ç‰¹æ•ˆï¼Œä¹Ÿå¯ä»¥ï¼š
  // await Promise.all([playCardPetalsOnce(), playCamelUseFx()]);
});


  // â‘¡ ä½¿ç”¨å‰é€²å¡å¾Œï¼Œé¸æ‰‹å¯¦éš›å‰é€²ä¸­ï¼ˆé€™è£¡åªç§»å‹•ï¼Œä¸å†é‡ç¿»å¡ï¼‰
  steps.push(async ()=>{
    const whoName = findName(s.who);
    const moveIds  = [s.who];
    const stepsMap = { [s.who]: s.card ?? 0 };

    showOverlay(`ç¬¬ ${r.round} å›åˆ`, [
      `${whoName} ä½¿ç”¨å‰é€²å¡ï¼Œé¸æ‰‹å‰é€²ä¸­â€¦`
    ], {
      showCard: true,
      cardText: `+${s.card}`,
      flip: false,                   // é€™è£¡ä¸å†ç¿»å¡ï¼Œåªç¶­æŒå¡é¢
      cardHint: "ä½¿ç”¨å‰é€²å¡",
      playersList: [s.who],
      badgeText: reasonText,
    });

    await moveMany(moveIds, stepsMap, { focusIds: moveIds });
    await sleep(260 / state.speed);
  });
  continue;
}


            // ä¸€èˆ¬æŠ½å¡
            steps.push(async ()=>{
              const whoName = findName(s.who);
              const lines = [
                `${whoName}ï¼Œ${s.date}`,
                s.note ? `å‚™è¨»ï¼š${s.note}` : "æº–å‚™æŠ½å¡â€¦"
              ];
              showOverlay(`ç¬¬ ${r.round} å›åˆ`, lines, {
                showCard: true,
                cardText: `+${s.card}`,
                flip: false,
                cardHint: "å¡ç‰‡å°šæœªç¿»é–‹",
                playersList: [s.who],
                badgeText: reasonText,
              });
              await sleep(900 / state.speed);
            });

            steps.push(async ()=>{
              showOverlay(`ç¬¬ ${r.round} å›åˆ`, [
                `${findName(s.who)} æŠ½å¡çµæœï¼š+${s.card}`
              ], {
                showCard: true,
                cardText: `+${s.card}`,
                flip: true,
                cardHint: "æŠ½å¡çµæœ",
                playersList: [s.who],
                badgeText: reasonText,
              });
              await sleep(850 / state.speed);
            });

                        steps.push(async ()=>{
              showOverlay(`ç¬¬ ${r.round} å›åˆ`, [
                `${findName(s.who)} å‰é€² ${s.card} æ ¼`
              ]);   // â† æ‹¿æ‰ badgeText
              await moveMany([s.who], {[s.who]: s.card}, {focusIds:[s.who]});
              await sleep(300 / state.speed);
            });

          }
        }

        // å›åˆçµå°¾
        steps.push(async ()=>{
          if (state.finished){
            showOverlay(`ç¬¬ ${r.round} å›åˆçµæŸ`, [
              `âš‘ å·²æœ‰é¸æ‰‹æŠµé”çµ‚é»ï¼ˆ${FINISH} æ ¼ï¼‰ã€‚`
            ]);
          }else{
            showOverlay(`ç¬¬ ${r.round} å›åˆçµæŸ`, ["æ›´æ–°å³æ™‚æ’åâ€¦"]);
          }
          await sleep(800 / state.speed);
        });
      }

      // æ’­æ”¾çµæŸ
      steps.push(async ()=>{
        const ordered = getOrderedPlayers();
        const top = ordered[0];
        showOverlay("æ’­æ”¾çµæŸ", [
          `ç¬¬ä¸€åï¼š${top.name}ï¼ˆğŸ¾ ${state.pos[top.id]} æ ¼ï¼‰`
        ]);
      });

      return steps;
    }

    // ====== æ’­æ”¾æ§åˆ¶ ======
    let playing = false;
    let cursor  = 0;

    async function runAuto(){
      if (playing) return;
      playing = true;
      btnStart.disabled = true;
      btnNext.disabled  = true;
      btnPrev.disabled  = true;

      while (playing && cursor < state.stepQueue.length){
        await state.stepQueue[cursor]();
        cursor++;
      }

      playing = false;
      btnStart.disabled = false;
      btnNext.disabled  = false;
      btnPrev.disabled  = false;
    }

    async function runNext(){
      if (cursor >= state.stepQueue.length) return;
      btnNext.disabled = true;
      btnPrev.disabled = true;
      await state.stepQueue[cursor]();
      cursor++;
      btnNext.disabled = false;
      btnPrev.disabled = false;
    }

    async function runToStep(target){
      fastMode = true;
      baseReset(false);
      state.stepQueue = buildStepsFromRounds();
      cursor = 0;
      for (let i=0; i<target; i++){
        await state.stepQueue[i]();
        cursor = i+1;
      }
      fastMode = false;
    }

    async function runPrev(){
      if (cursor <= 0) return;
      const target = cursor - 1;
      playing = false;
      btnStart.disabled = true;
      btnNext.disabled  = true;
      btnPrev.disabled  = true;
      await runToStep(target);
      btnStart.disabled = false;
      btnNext.disabled  = false;
      btnPrev.disabled  = false;
    }

    // ====== å¾æŒ‡å®šã€Œå›åˆã€é–‹å§‹æ’­æ”¾ ======
    async function jumpToRound(roundNumber){
      playing = false;

      btnStart.disabled = true;
      btnNext.disabled  = true;
      btnPrev.disabled  = true;

      baseReset(false);
      state.stepQueue = buildStepsFromRounds();

      const map = state.roundStartStep || {};
      const targetIndex = map[roundNumber];

      if (typeof targetIndex !== "number"){
        btnStart.disabled = false;
        btnNext.disabled  = false;
        btnPrev.disabled  = false;
        return;
      }

      fastMode = true;
      for (let i = 0; i < targetIndex; i++){
        await state.stepQueue[i]();
        cursor = i + 1;
      }
      fastMode = false;

      btnStart.disabled = false;
      btnNext.disabled  = false;
      btnPrev.disabled  = false;

      runAuto();
    }

    function baseReset(showIntro = true){
      playing = false;
cursor  = 0;
state.finished    = null;
state.finishOrder = [];   // ğŸ”¹ æ¸…æ‰é€šé—œé †åº

// â­ æ¸…æ‰å† è»æ˜Ÿæ˜Ÿçš„å®šæ™‚å™¨
  if (winnerStarInterval){
    clearInterval(winnerStarInterval);
    winnerStarInterval = null;
  }

      players.forEach(p => {
        state.pos[p.id] = 0;

        const lane   = document.querySelector(`.lane[data-id="${p.id}"]`);
        const marker = document.getElementById(`marker-${p.id}`);
        if (lane){
          lane.classList.remove("winner","dim","focus");
        }
        if (marker){
          marker.classList.remove("winner-marker");
          const crown = marker.querySelector(".lane-crown");
          if (crown){
            crown.classList.remove("show");
          }
        }
        if (marker){
  marker.classList.remove("rivalry-hot");
}

        if (marker){
  // âœ… æ¸…ç†ã€Œå®Œæˆå¾Œç‹€æ…‹ã€ç›¸é—œè¦–è¦º
  marker.classList.remove("finished","star-power","rainbow-power");

  const rocket = marker.querySelector(".lane-rocket");
  if (rocket) rocket.remove();

  // ï¼ˆä½ åŸæœ¬çš„ winner-marker/crown æ¸…ç†ä¿ç•™ï¼‰
}

      });

      updateAllProgress();
      updateRank();
      updateClearRank();

      fireworksEl.style.display = "none";
      fireworksEl.innerHTML = "";
      itemFxEl.style.display = "none";
      itemFxEl.innerHTML = "";

      if (winnerBannerEl){
        winnerBannerEl.classList.remove("show","fadeout");
        winnerBannerEl.textContent = "";
      }

      if (showIntro){
        showOverlay("æº–å‚™é–‹å§‹", [
          "è«‹æŒ‰ã€Œé–‹å§‹æ’­æ”¾ã€è‡ªå‹•æ’­æ”¾ï¼Œæˆ–æŒ‰ã€Œä¸‹ä¸€æ­¥ã€é€æ®µæŸ¥çœ‹ã€‚",
        ]);
      }
    }

    function resetAll(){
      baseReset(true);
      state.stepQueue = buildStepsFromRounds();
      btnStart.disabled = false;
      btnNext.disabled  = false;
      btnPrev.disabled  = false;
    }

    // ====== ç¬¬ä¸€åæ…¶ç¥ï¼šï¼“ç§’å† è»æ©«å¹… + å…¨è¢å¹•ç…™ç« ======
    async function celebrateFinish(playerId){
  if (fastMode) return;
  // âœ… é‡è¦ï¼šå† è»æ…¶ç¥æœŸé–“ï¼Œå…ˆåœæ‰æ‰€æœ‰ä¸» BGMï¼ˆnormal / nervous / finishï¼‰
  stopAllMainBgm();
  currentMainBgm = null;

  const name = findName(playerId);

  const lane = document.querySelector(`.lane[data-id="${playerId}"]`);
  if (lane){
    lane.classList.add("winner");
    burstWinnerStars(lane);   // å…ˆå™´ä¸€æ¬¡ï¼Œç•¶ä½œç¬¬ä¸€ç™¼

    // â­ æ¯éš”ä¸€æ®µæ™‚é–“é‡è¤‡å™´æ˜Ÿæ˜Ÿ
    if (!winnerStarInterval){
      winnerStarInterval = setInterval(() => {
        // å¦‚æœé€™æ¢è³½é“å·²ç¶“ä¸åœ¨ç•«é¢ä¸Šæˆ–ä¸å†æ˜¯ winnerï¼Œå°±è‡ªå‹•åœæ­¢
        if (!document.body.contains(lane) || !lane.classList.contains("winner")){
          clearInterval(winnerStarInterval);
          winnerStarInterval = null;
          return;
        }
        burstWinnerStars(lane);
      }, 1600);   // æƒ³æ›´å¯†å¯ä»¥èª¿å°ä¸€é»
    }
  }

      const marker = document.getElementById(`marker-${playerId}`);
      if (marker){
        marker.classList.add("winner-marker");

        const crown = marker.querySelector(".lane-crown");
        if (crown){
          crown.classList.add("show");
        }
      }

      if (winnerBannerEl){
        winnerBannerEl.textContent = `ğŸ† ç¬¬ä¸€åï¼š${name}`;
        winnerBannerEl.classList.remove("show","fadeout");
        void winnerBannerEl.offsetWidth;
        winnerBannerEl.classList.add("show");
      }

      // âœ… è®“ç…™ç«èˆ‡æ©«å¹…åœç•™ã€Œè‡³å°‘ä¸ƒç§’ã€ï¼Œé…åˆ celebrate æ’­æ”¾æ™‚é–“
const CELEBRATE_MS = 7000;

// âœ… æ’­æ”¾ç…™ç«ï¼šå»ºè­°ä¹Ÿæ”¹æˆ 7 ç§’ï¼Œç•«é¢æ‰ä¸€è‡´
playFireworks(CELEBRATE_MS);

showOverlay("ğŸ† ç¬¬ä¸€åå‡ºç¾ï¼", [
  `${name} æŠµé”ç¬¬ ${FINISH} æ ¼çµ‚é»ï¼`,
  "è³½é“èˆ‡å³æ™‚æ’åå·²æ¨™è¨˜å† è» ğŸ‘‘ã€‚"
]);

// âœ… åŒæ­¥ç­‰å¾…ï¼šcelebrate æ’­ä¸ƒç§’ï¼ˆä¸åŠ é€Ÿï¼‰
// ï¼ˆé€™ä¸€è¡Œå°±æ˜¯ã€Œç•«é¢åœä½ï¼Œç­‰éŸ³æ•ˆæ’­å®Œã€çš„é—œéµï¼‰
await playCelebrate7sOnce();

// âœ… celebrate æ’­å®Œæ‰åˆ‡åˆ° finish.mp3
await playMainBgm("finish");

// âœ… ä½ å¦‚æœå¸Œæœ›ã€Œåˆ‡åˆ° finish çš„ç¬é–“ã€æ©«å¹…æ‰é–‹å§‹æ·¡å‡ºï¼Œå¯ä»¥ä¿ç•™çŸ­æš«åœç•™
// ä¾‹å¦‚åœ 200~400ms è®“åˆ‡æ­Œæ›´æœ‰æ„Ÿ
await sleep(260);
// âœ… æ”¶æ©«å¹…ï¼šæ·¡å‡º â†’ æ¸…å­—
if (winnerBannerEl){
  winnerBannerEl.classList.remove("show");
  winnerBannerEl.classList.add("fadeout");

  // ç­‰æ·¡å‡ºå‹•ç•«è·‘å®Œï¼ˆé€™å€‹æ™‚é–“è¦è·Ÿä½ çš„ CSS transition å°é½Šï¼‰
  await sleep(420);

  winnerBannerEl.classList.remove("fadeout");
  winnerBannerEl.textContent = "";
}

    }

    // ====== äº‹ä»¶ç¶å®š ======

// â–¶ ä¸»æ’­æ”¾æŒ‰éˆ•ï¼šé–‹å§‹è‡ªå‹•æ’­æ”¾ + å•Ÿå‹•å¸¸é§ BGM
btnStart.addEventListener("click", ()=> {
  // ç¬¬ä¸€æ¬¡é–‹å§‹æ’­æ”¾æ™‚ï¼Œåˆ‡åˆ°ä¸€èˆ¬ BGM
  playMainBgm("normal");
  runAuto();
});

// â–¶ å–®æ­¥å‰é€² / å¾Œé€€ï¼šåªæ§åˆ¶å‹•ç•«ï¼Œä¸å‹•éŸ³æ¨‚
btnNext.addEventListener("click", ()=> runNext());
btnPrev.addEventListener("click", ()=> runPrev());

// â–¶ resetï¼šé‡è¨­è³½é“ + é‡è¨­éŸ³æ¨‚ç‹€æ…‹ + æ’­å› normal
btnReset.addEventListener("click", ()=> {
  // æ¸…æ‰æ‰€æœ‰ BGM ç‹€æ…‹
  resetBgm();
  nervousStarted = false;
  finishStarted  = false;
  rivalryStarted = false;
  rivalryEnded   = false;

  // é‡è¨­è³½é“èˆ‡å‹•ç•«ç‹€æ…‹
  resetAll();

  // å›åˆ°å¸¸é§ BGM
  playMainBgm("normal");
});


// â–¶ æ’­æ”¾é€Ÿåº¦èª¿æ•´ï¼šè·ŸåŸæœ¬ä¸€æ¨£
speedEl.addEventListener("input", ()=>{
  state.speed = Number(speedEl.value);
  speedTextEl.textContent = `${state.speed.toFixed(1)}x`;
});

// â–¶ å¾é–‹å ´ç•«é¢ç›´æ¥é–‹å§‹æ’­æ”¾
splashStart.addEventListener("click", async ()=> {
  splash.style.display = "none";
requestFitStage();
  // ä¸€æ¨£å…ˆå•Ÿå‹•ä¸€èˆ¬ BGM
  playMainBgm("normal");

  await runAuto();
});

// â–¶ åªé—œé–‰é–‹å ´ç•«é¢ï¼Œä¸æ’­æ”¾ï¼ˆé€™è£¡ä¸å‹•éŸ³æ¨‚ï¼‰
splashLater.addEventListener("click", ()=> {
  splash.style.display = "none";
  requestFitStage();
});


    // ====== åˆå§‹åŒ– ======
    fitStage();
    buildLanes();
    updateRank();
    updateClearRank();
    state.stepQueue = buildStepsFromRounds();
    buildRoundJumpButtons();
        showOverlay("æº–å‚™é–‹å§‹", [
      "ä¸»èˆå°ï¼šä¸Šæ–¹å­—å¹•å¡ã€ä¸‹æ–¹è³½é“ã€‚",
      "å³å´ï¼šå³æ™‚æ’åï¼ˆä¸­æ–‡åï¼‰ã€‚çµ‚é»ï¼š46 æ ¼ï¼ˆç¬¬ä¸€å€‹åˆ°é”è€… = å† è»ï¼‰ã€‚"
    ]);
  </script>
  </div>
  </div>
</body>
</html>
